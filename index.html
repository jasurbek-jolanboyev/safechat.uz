<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SafeChat Connection | Secure Messaging</title>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    
<style>
/* =========================================================
   0. ROOT VA ASOSIY SOZLAMALAR
========================================================= */
:root {
    --ios-bg: #f2f2f7;
    --ios-accent: #007aff;
    --glass: rgba(255, 255, 255, 0.85);
    --radius-xl: 32px;
    --vh: 1vh;
}

* { 
    -webkit-tap-highlight-color: transparent; 
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
    box-sizing: border-box;
}

body, html {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* Skrol faqat ichki elementlarda bo'ladi */
    background-color: var(--ios-bg);
}

/* Dark Mode asosiy tana ranglari */
.dark body { background-color: #1c1c1e; color: white; }
.dark .bg-white { background-color: #2c2c2e !important; color: white !important; }

#mainApp {
    height: calc(var(--vh, 1vh) * 100);
    display: flex;
    flex-direction: column;
}

/* =========================================================
   1. ANIMATSIYALAR
========================================================= */
@keyframes slideUpFull {
    from { transform: translateY(100%); opacity: 0.8; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-slide-up { animation: slideUpFull 0.4s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }
.animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

/* =========================================================
   2. NAVIGATSIYA & INDIKATOR
========================================================= */
#navIndicator {
    position: absolute;
    bottom: 8px;
    height: 52px;
    background: rgba(0, 122, 255, 0.1);
    border-radius: 28px;
    transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
    z-index: 0;
}

.bottom-nav { 
    position: fixed; bottom: 0; left: 0; right: 0; 
    height: 85px; background: var(--glass); 
    backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); 
    display: flex; justify-content: space-around; 
    padding-top: 10px; z-index: 100; 
}

.nav-item { 
    display: flex; flex-direction: column; align-items: center; 
    color: #8e8e93; font-size: 11px; flex: 1; transition: 0.2s; 
}
.nav-item.active { color: var(--ios-accent); }
.nav-item i { font-size: 24px; margin-bottom: 4px; }

/* =========================================================
   3. CHAT AREA & XABARLAR
========================================================= */
#chatArea {
    position: fixed;
    inset: 0;
    background: #F2F2F7;
    z-index: 5000; 
    display: none;
    flex-direction: column;
    width: 100%;
    height: 100%;
}

#msgBox {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #e5ddd5;
    display: flex;
    flex-direction: column;
    -webkit-overflow-scrolling: touch;
}

.bubble { 
    max-width: 75%; 
    padding: 10px 14px; 
    border-radius: 18px; 
    font-size: 16px; 
    margin-bottom: 8px; 
    line-height: 1.4; 
    word-wrap: break-word; 
    position: relative;
    cursor: pointer;
    transition: transform 0.1s;
}

.bubble.sent { 
    background: var(--ios-accent); 
    color: white; 
    align-self: flex-end; 
    border-bottom-right-radius: 4px; 
}

.bubble.received { 
    background: white; 
    color: black; 
    align-self: flex-start; 
    border-bottom-left-radius: 4px; 
}

.bubble:active { transform: scale(0.97); }

/* =========================================================
   4. EMPTY STATE (Telegram-style)
========================================================= */
.empty-state {
    opacity: 1 !important;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #1c1c1e;
}

.empty-state p {
    margin: 4px 0;
    font-size: 13px;
    color: #4b5563; /* kontrast gray */
}

.empty-state button {
    margin-top: 12px;
    background-color: #007aff;
    color: #fff;
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
    transition: 0.2s all;
    cursor: pointer;
}
.empty-state button:hover { transform: scale(1.05); }

/* =========================================================
   5. FULL PROFILE
========================================================= */
#profileCircle {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#profileCircle:active { transform: scale(0.9) rotate(-2deg); }

#fullUserProfile { background-color: #ffffff; }
#fullProfileScrollArea { background-color: #f2f2f7; }

.dark #fullUserProfile { background-color: #000000 !important; }
.dark #fullProfileScrollArea { background-color: #000000 !important; }
.dark #fullUserProfile .bg-white { background-color: #1c1c1e !important; color: #ffffff !important; }
.dark #fullUserProfile .text-gray-800, .dark #fullUserProfile .text-gray-900 { color: #ffffff !important; }
.dark #fullUserProfile .text-gray-600, .dark #fullUserProfile .text-gray-700 { color: #a1a1a6 !important; }
.dark #fullUserProfile .text-gray-400 { color: #8e8e93 !important; }
.dark #fullUserProfile .border-gray-50, .dark #fullUserProfile .divide-gray-50 > * { border-color: #2c2c2e !important; }

/* =========================================================
   6. IOS SHEETS & OVERLAY
========================================================= */
.ios-sheet {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    background: white;
    z-index: 6000; 
    transition: bottom 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    border-radius: 24px 24px 0 0;
    padding-bottom: env(safe-area-inset-bottom, 20px);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
    max-height: 90%;
    overflow-y: auto;
}
.ios-sheet.active { bottom: 0; }

.sheet-handle { width: 36px; height: 5px; background: #c7c7cc; border-radius: 3px; margin: 12px auto; }

.sheet-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
    z-index: 5500; display: none; backdrop-filter: blur(4px);
    animation: fadeIn 0.3s ease;
}
.sheet-overlay.active { display: block; }

/* =========================================================
   7. QO'SHIMCHA ELEMENTLAR
========================================================= */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

.media-content { border-radius: 12px; margin-top: 5px; max-width: 100%; display: block; }

#adminPanel { 
    display: none; background: #1c1c1e; color: #32d74b; 
    position: fixed; inset: 0; z-index: 9999; padding: 20px; 
}

/* =========================================================
   8. DARK MODE ADDITIONAL
========================================================= */
.dark .ios-sheet { background: #1c1c1e !important; color: white; }
.dark .ios-sheet .bg-gray-50 { background: #2c2c2e !important; }
.dark .ios-sheet span { color: white !important; }


</style>
</head>
<body>

    <div id="installBanner" class="install-banner glass-panel p-4 rounded-3xl shadow-2xl flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white"><i class="fa-solid fa-download"></i></div>
            <div><p class="text-sm font-bold">SafeChat App</p><p class="text-xs text-gray-500">Ilovani o'rnatishni tavsiya qilamiz</p></div>
        </div>
        <button onclick="installApp()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold">O'rnatish</button>
    </div>

<div id="countryModal" class="hidden fixed inset-0 z-[7000] bg-white flex flex-col animate-slide-up">
    <div class="p-4 flex items-center gap-4 border-b">
        <i class="fa-solid fa-arrow-left text-xl cursor-pointer" onclick="closeCountryModal()"></i>
        <input type="text" id="countrySearch" oninput="filterCountries()" placeholder="Davlatni qidirish..." class="flex-1 p-2 outline-none text-lg">
    </div>
    <div id="countryList" class="flex-1 overflow-y-auto">
        </div>
</div>

<div id="authScreen" class="fixed inset-0 z-[5000] flex items-center justify-center p-6 bg-[#f2f2f7]">
    <div class="glass-panel w-full max-w-[420px] p-8 rounded-[40px] shadow-2xl bg-white/80 backdrop-blur-xl">
        <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white text-4xl shadow-lg">
            <i class="fa-solid fa-shield-halved"></i>
        </div>
        
        <div id="loginView">
            <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">Kirish</h1>
            <p class="text-gray-500 text-center mb-8">SafeChat Tizimiga qaytish</p>
            <div class="space-y-4">
                <div class="relative">
                    <input type="text" id="login_u" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="username">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">.connect.uz</span>
                </div>
                <input type="password" id="login_p" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="Parol">
                <button onclick="login()" class="w-full py-4 bg-blue-600 text-white rounded-[20px] text-lg font-semibold shadow-xl active:scale-95 transition">Tizimga kirish</button>
                <p class="text-center text-sm text-gray-500 mt-4">Hisobingiz yo'qmi? <span onclick="toggleAuth(true)" class="text-blue-600 font-bold cursor-pointer">Ro'yxatdan o'tish</span></p>
            </div>
        </div>

        <div id="registerView" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-2">Ro'yxatdan o'tish</h1>
            <p class="text-gray-500 text-center mb-6 text-sm">Xalqaro xavfsiz hisob yarating</p>
            
            <div class="space-y-3">
                <div onclick="openCountryModal()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl flex items-center justify-between cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span id="selectedFlag" class="text-2xl">ðŸ‡ºðŸ‡¿</span>
                        <span id="selectedCountryName" class="font-medium">Uzbekistan</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-400"></i>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="phoneCode" class="w-20 p-4 bg-gray-50 border border-gray-100 rounded-2xl text-center font-bold" value="+998" readonly>
                    <input type="tel" id="reg_phone" class="flex-1 p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="901234567">
                </div>

                <div class="relative">
                    <input type="text" id="reg_u" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="username">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">.connect.uz</span>
                </div>
                
                <input type="password" id="reg_p" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="Parol">
                <button onclick="register()" class="w-full py-4 bg-green-600 text-white rounded-[20px] text-lg font-semibold shadow-xl">Hisobni yaratish</button>
                <p class="text-center text-sm text-gray-500 mt-4">Hisobingiz bormi? <span onclick="toggleAuth(false)" class="text-blue-600 font-bold cursor-pointer">Kirish</span></p>
            </div>
        </div>
        
        <p onclick="showAdminLogin()" class="text-center text-[10px] text-gray-400 mt-8 uppercase tracking-widest cursor-pointer hover:text-blue-500">CEO & ADMIN ACCESS ONLY</p>
    </div>
</div>

    <div id="mainApp" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
<aside class="w-full md:w-[380px] flex-shrink-0 border-r border-gray-100 flex flex-col bg-[#f2f2f7] relative h-screen overflow-y-auto z-40">

    <!-- HEADER -->
    <header class="p-4 bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
        <div class="flex justify-between items-center mb-4">
            <h2 id="tabTitle" class="text-2xl font-black text-gray-900">Chatlar</h2>
            <button id="toggleSearch" class="text-gray-500 text-xl cursor-pointer">
                <i class="fa-solid fa-magnifying-glass"></i>
            </button>
        </div>

        <div id="searchWrapper" class="relative hidden transition-all duration-300">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="userSearch" oninput="liveSearch(this.value)"
                class="w-full p-2.5 pl-11 bg-gray-100 rounded-xl outline-none focus:bg-white transition-all text-sm"
                placeholder="Qidiruv...">
        </div>
    </header>

    <!-- TABLAR ZONA -->
    <div class="flex-1 overflow-y-auto no-scrollbar pb-28">

        <!-- CHAT TAB -->
        <div id="chatsTab" class="tab-content p-4 space-y-2">
            <div id="chatList" class="space-y-1"></div>
        </div>

        <!-- GROUP TAB -->
        <div id="groupsTab" class="tab-content hidden p-4 space-y-2">
            <div id="groupList" class="space-y-1"></div>
        </div>

        <!-- PROFILE TAB (TOâ€˜Gâ€˜RI JOYDA!) -->
       <div id="profileTab" class="tab-content hidden bg-[#f2f2f7] min-h-screen pb-28 animate-fade-in">
    <div class="flex flex-col items-center py-10 bg-white border-b border-gray-200">
        <div class="relative group">
            <img id="profileAvatar" src="https://ui-avatars.com/api/?name=U" 
                class="w-28 h-28 rounded-full shadow-lg object-cover border-4 border-white cursor-pointer transition active:scale-95"
                onclick="triggerAvatarUpload()">
            <div class="absolute bottom-0 right-0 bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center border-2 border-white text-white text-xs">
                <i class="fa-solid fa-camera"></i>
            </div>
            <input type="file" id="avatarInput" class="hidden" accept="image/*" onchange="handleAvatarSelection(event)">
        </div>

        <h2 id="profileName" class="mt-4 text-2xl font-black text-gray-900 leading-tight">Loading...</h2>
        <p id="profileUsername" class="text-blue-600 font-bold text-sm tracking-wide">@username</p>
        
        <div onclick="openStatusSheet()" class="mt-2 px-4 py-1 bg-gray-100 rounded-full cursor-pointer hover:bg-gray-200 transition">
            <span id="profileStatusDisplay" class="text-xs text-gray-500 italic font-medium">Status o'rnatish...</span>
        </div>

        <div class="flex gap-2 mt-5">
            <button onclick="switchTab('settings')" class="px-8 py-2.5 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-200 font-bold active:scale-95 transition text-sm">
                Edit Profile
            </button>
            <button onclick="copyMyID()" class="px-4 py-2.5 bg-white text-gray-700 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition">
                <i class="fa-solid fa-share-nodes"></i>
            </button>
        </div>
    </div>

    <div class="mt-6 space-y-4 px-4">
        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm border border-gray-100">
            <div onclick="alert('Saqlangan xabarlar tez kunda!')" class="flex items-center justify-between p-4 border-b border-gray-50 active:bg-gray-50 transition cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-bookmark"></i></div>
                    <span class="font-bold text-gray-800 text-sm">Saqlangan xabarlar</span>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
            </div>

            <div onclick="unlockHiddenChats()" class="flex items-center justify-between p-4 active:bg-gray-50 transition cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-eye-slash"></i></div>
                    <span class="font-bold text-gray-800 text-sm">Yashirin chatlar</span>
                </div>
                <div class="flex items-center gap-2">
                    <i id="lockStatusIcon" class="fa-solid fa-lock text-gray-300 text-xs"></i>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm border border-gray-100">
            <div onclick="openDeviceSheet()" class="flex items-center justify-between p-4 active:bg-gray-50 transition cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-gray-50 text-gray-600 rounded-xl flex items-center justify-center"><i class="fa-solid fa-laptop"></i></div>
                    <span class="font-bold text-gray-800 text-sm">Faol seanslar (Devices)</span>
                </div>
                <span class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-0.5 rounded-full">3 active</span>
            </div>
        </div>
    </div>
</div>

<div id="settingsTab" class="tab-content hidden bg-[#f2f2f7] min-h-screen pb-28 animate-fade-in">
    <div class="px-4 pt-8 space-y-6">
        <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden">
            <p class="px-5 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50/50">Hisob ma'lumotlari</p>
            <div onclick="editField('Name')" class="flex items-center justify-between p-4 border-b border-gray-50 active:bg-gray-50 cursor-pointer">
                <span class="font-bold text-gray-700 text-sm">Ism</span>
                <span id="settingsName" class="text-gray-400 text-sm font-medium">Loading...</span>
            </div>
            <div onclick="editField('Username')" class="flex items-center justify-between p-4 border-b border-gray-50 active:bg-gray-50 cursor-pointer">
                <span class="font-bold text-gray-700 text-sm">Username</span>
                <span id="settingsUsername" class="text-blue-500 text-sm font-bold">@username</span>
            </div>
            <div onclick="editField('Bio')" class="flex items-center justify-between p-4 active:bg-gray-50 cursor-pointer">
                <span class="font-bold text-gray-700 text-sm">Bio</span>
                <span id="settingsBio" class="text-gray-400 text-sm italic">No bio</span>
            </div>
        </div>

        <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden">
            <p class="px-5 py-3 text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50/50">Xavfsizlik</p>
            <div onclick="openTwoFASheet()" class="flex items-center justify-between p-4 border-b border-gray-50 active:bg-gray-50 cursor-pointer">
                <span class="font-bold text-gray-700 text-sm">2-Step Verification</span>
                <span id="twoFAStatusLabel" class="text-red-500 text-[10px] font-black bg-red-50 px-2 py-1 rounded-lg">OFF</span>
            </div>
            <div onclick="openSheet('hiddenPinSheet')" class="flex items-center justify-between p-4 active:bg-gray-50 cursor-pointer">
                <span class="font-bold text-gray-700 text-sm">Hidden Chats PIN</span>
                <i class="fa-solid fa-key text-gray-300"></i>
            </div>
        </div>

        <div class="bg-white rounded-[28px] shadow-sm border border-gray-100 overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-900 text-white rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-moon"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Tungi rejim</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" onchange="toggleDarkMode(this)" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer-checked:bg-blue-600 after:absolute after:top-[2px] after:left-[2px] after:h-5 after:w-5 after:bg-white after:rounded-full after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
            </div>
        </div>

        <button onclick="logout()" class="w-full py-4 bg-white text-red-600 rounded-2xl font-black shadow-sm active:scale-[0.98] transition border border-red-50 mt-4 mb-10">
            Hisobdan chiqish
        </button>
    </div>
</div>

    <!-- BOTTOM NAVBAR -->
    <div class="fixed bottom-5 left-0 right-0 px-5 pb-[env(safe-area-inset-bottom,24px)] pt-6 z-50 bg-gradient-to-t from-gray-50/80 to-transparent pointer-events-none">
        <nav class="pointer-events-auto bg-white/70 backdrop-blur-[25px] border border-white/40 rounded-[38px] shadow-[0_12px_40px_rgba(0,0,0,0.08)] p-2 flex justify-around items-center relative overflow-hidden ring-1 ring-black/[0.03]">

            <div id="navIndicator" class="absolute h-[52px] bg-[#007aff]/10 rounded-[28px] transition-all duration-500 ease-[cubic-bezier(0.2,1,0.3,1)] z-0"></div>

            <button id="nav-chats" onclick="switchTab('chats')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-[#007aff] transition-all duration-300 active:scale-90">
                <i class="fa-solid fa-comment-dots text-[22px]"></i>
                <span class="text-[10px] mt-1 font-semibold tracking-tight">Chatlar</span>
            </button>

            <button id="nav-groups" onclick="switchTab('groups')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
                <i class="fa-solid fa-globe text-[22px]"></i>
                <span class="text-[10px] mt-1 font-semibold tracking-tight">Ommaviy</span>
            </button>

            <div class="flex items-center justify-center px-2">
                <button onclick="openSheet('createEntitySheet')" class="flex items-center justify-center w-[54px] h-[54px] bg-[#007aff] rounded-full shadow-[0_8px_20px_rgba(0,122,255,0.3)] z-20 active:scale-[0.85] transition-all duration-300 hover:brightness-110">
                    <i class="fa-solid fa-plus text-white text-2xl"></i>
                </button>
            </div>

            <button id="nav-settings" onclick="switchTab('settings')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
                <i class="fa-solid fa-gears text-[22px]"></i>
                <span class="text-[10px] mt-1 font-semibold tracking-tight">Sozlamalar</span>
            </button>

            <button id="nav-profile" onclick="switchTab('profile')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
                <i class="fa-solid fa-circle-user text-[22px]"></i>
                <span class="text-[10px] mt-1 font-semibold tracking-tight">Profil</span>
            </button>

        </nav>
    </div>

</aside>


        <main id="chatArea" class="flex flex-1 flex-col bg-white relative md:flex">
            <header class="p-4 pt-14 flex justify-between items-center border-b glass-panel sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-blue-600 mr-2" onclick="closeChatArea()"><i class="fa-solid fa-chevron-left text-xl"></i></button>
                    <img id="activeChatImg" src="" class="w-11 h-11 rounded-full object-cover">
                    <div onclick="openUserMenu()">
                        <h4 id="activeName" class="font-bold text-[17px]">Suhbatdosh</h4>
                        <p class="text-xs text-blue-500">online</p>
                    </div>
                </div>
                <div class="flex gap-5 text-blue-600 text-xl">
                    <i class="fa-solid fa-phone cursor-pointer" onclick="initiateCall('audio')"></i>
                    <i class="fa-solid fa-video cursor-pointer" onclick="initiateCall('video')"></i>
                    <i class="fa-solid fa-circle-info cursor-pointer" onclick="openSheet('ceoSheet')"></i>
                </div>
            </header>

            <div id="msgBox" class="flex-1 overflow-y-auto p-6 flex flex-col no-scrollbar bg-[#f2f2f7]"></div>

            <footer id="chatFooter" class="p-4 pb-10 flex items-center gap-3 glass-panel">
                <i class="fa-solid fa-plus text-blue-600 text-2xl cursor-pointer" onclick="openSheet('mediaSheet')"></i>
                <input type="text" id="msgInp" onkeypress="handleEnter(event)" placeholder="Xabar yozing..." class="flex-1 p-3 bg-gray-100 rounded-[24px] outline-none border-0 focus:ring-2 focus:ring-blue-100 transition">
                <button onclick="sendMsg()" id="sendBtn" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                    <i id="sendBtnIcon" class="fa-solid fa-arrow-up"></i>
                </button>
            </footer>
        </main>
    </div>

        <div id="msgContextMenu" class="context-menu hidden">
            <button onclick="handleReply()"><i class="fa-solid fa-reply text-blue-500"></i> Javob berish</button>
            <button onclick="copyMsg()"><i class="fa-solid fa-copy text-gray-500"></i> Nusxalash</button>
            
            <button id="editBtn" onclick="startEditMsg()"><i class="fa-solid fa-pen text-amber-500"></i> Tahrirlash</button>
            
            <button onclick="handleForward()"><i class="fa-solid fa-share text-green-500"></i> Uzatish</button>
            <button onclick="handlePin()"><i class="fa-solid fa-thumbtack text-purple-500"></i> Qadash (Pin)</button>
            <button onclick="toggleSelectMode()"><i class="fa-solid fa-check-double text-blue-400"></i> Tanlash</button>
            
            <button id="deleteBtn" onclick="deleteMsgServer()" class="text-red-500 border-t mt-1 pt-1">
                <i class="fa-solid fa-trash"></i> O'chirish
            </button>
        </div>

        <div id="replyPreview" class="hidden border-l-4 border-blue-500 mx-2 my-1 rounded-r-lg bg-white/20 backdrop-blur-md">
    </div>

        <div id="selectionBar" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-lg rounded-2xl shadow-2xl px-6 py-3 flex gap-8 z-[50] border border-gray-200">
            <button onclick="bulkCopy()" class="flex flex-col items-center text-blue-600">
                <i class="fa-solid fa-copy"></i><span class="text-[10px] mt-1">Copy</span>
            </button>
            <button onclick="bulkForward()" class="flex flex-col items-center text-green-600">
                <i class="fa-solid fa-share"></i><span class="text-[10px] mt-1">Forward</span>
            </button>
            <button onclick="bulkDelete()" class="flex flex-col items-center text-red-600">
                <i class="fa-solid fa-trash"></i><span class="text-[10px] mt-1">Delete</span>
            </button>
            <button onclick="cancelSelection()" class="flex flex-col items-center text-gray-500">
                <i class="fa-solid fa-xmark"></i><span class="text-[10px] mt-1">Exit</span>
            </button>
        </div>

    <div id="createEntitySheet" class="ios-sheet h-[60%]">
        <div class="sheet-handle"></div>
        <div class="p-8">
            <h2 class="text-3xl font-black mb-6 text-gray-800">Yangi yaratish</h2>
            <div class="flex bg-gray-200 p-1 rounded-2xl mb-6">
                <button id="btnTypeGroup" onclick="setEntityType('group')" class="flex-1 py-3 rounded-xl bg-white shadow-sm font-bold text-gray-800">Guruh</button>
                <button id="btnTypeChannel" onclick="setEntityType('channel')" class="flex-1 py-3 rounded-xl font-bold text-gray-500">Kanal</button>
            </div>
            <input type="text" id="entityName" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none mb-4" placeholder="Nomi">
            <button onclick="createEntity()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">Tasdiqlash</button>
        </div>
    </div>

    <div id="mediaSheet" class="ios-sheet h-[45%]">
        <div class="sheet-handle"></div>
        <div class="p-8 grid grid-cols-4 gap-6 text-center">
            <div onclick="triggerUpload('image')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-image"></i></div>
                <span class="text-xs font-bold text-gray-600">Foto</span>
            </div>
            <div onclick="triggerUpload('video')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-video"></i></div>
                <span class="text-xs font-bold text-gray-600">Video</span>
            </div>
            <div onclick="triggerUpload('file')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-file"></i></div>
                <span class="text-xs font-bold text-gray-600">Fayl</span>
            </div>
            <div onclick="sendLocation()" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-green-100 text-green-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-location-dot"></i></div>
                <span class="text-xs font-bold text-gray-600">Joylashuv</span>
            </div>
        </div>
        <input type="file" id="mediaInp" hidden onchange="handleFile(this)">
    </div>

<div id="mediaPreviewModal" class="hidden fixed inset-0 z-[5500] bg-black flex flex-col">
    <div class="p-4 flex justify-between items-center text-white">
        <i class="fa-solid fa-xmark text-2xl cursor-pointer" onclick="closeMediaPreview()"></i>
        <span id="mediaTypeTitle" class="font-bold">Media yuborish</span>
        <div></div>
    </div>
    <div class="flex-1 flex items-center justify-center p-4">
        <div id="mediaDisplayArea" class="max-w-full max-h-full"></div>
    </div>
</div>

<div id="adminPanel" class="hidden fixed inset-0 z-[6000] bg-black text-green-400 font-mono p-4 md:p-8 overflow-y-auto" style="display: none;">
    <div class="flex justify-between items-center border-b border-green-700 pb-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold tracking-widest text-green-500">SAFECHAT_OS_v2.0</h2>
            <p class="text-[10px] opacity-70">ROOT_ACCESS: GRANTED</p>
        </div>
        <button onclick="closeAdmin()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded shadow-lg text-sm">TERMINATE_SESSION</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        </div>
</div>

<div id="applySheet" class="ios-sheet">
    <div class="sheet-handle"></div>
    <div class="p-6">
        <h2 class="text-2xl font-black mb-4">Ariza topshirish</h2>
        <div class="space-y-4">
            <input type="text" id="app_name" placeholder="Ism Familiya" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
            <input type="tel" id="app_phone" placeholder="Telefon raqam" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
            <textarea id="app_reason" placeholder="Nima uchun bizga qo'shilmoqchisiz?" class="w-full p-4 bg-gray-100 rounded-2xl outline-none h-32"></textarea>
            <button onclick="submitApplication()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold">Yuborish</button>
        </div>
    </div>
</div>
    <div id="sheetOverlay" class="sheet-overlay" onclick="closeAllSheets()"></div>
<div class="flex flex-col gap-4 items-center justify-center min-h-screen bg-gray-50">
    <h1 class="text-2xl font-bold">SafeChat-ni o'rnating</h1>
    <p class="text-gray-500 text-center px-6">Ilovani asosiy ekranga qo'shish orqali tezkor kirish imkoniga ega bo'ling.</p>
    
    <button id="installBtn" class="hidden bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">
        <i class="fa-brands fa-android mr-2"></i> Android uchun yuklab olish
    </button>

    <button id="iosInstallBtn" class="hidden bg-black text-white px-8 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">
        <i class="fa-brands fa-apple mr-2"></i> iOS uchun o'rnatish
    </button>
</div>

<div id="deleteActionSheet" class="fixed inset-0 bg-black/60 hidden z-[100] flex items-end sm:items-center justify-center transition-all duration-300">
    <div class="absolute inset-0" onclick="closeDeleteSheet()"></div>
    
    <div class="w-full sm:w-[400px] bg-white rounded-t-[30px] sm:rounded-[30px] p-6 relative animate-slide-up shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-trash-can text-2xl text-red-500"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Tasdiqlang</h3>
            <p class="text-gray-400 text-sm px-4 mt-1">
                Siz rostdan ham <span id="deleteTargetName" class="text-red-600 font-bold"></span> ni o'chirmoqchimisiz? Bu amalni ortga qaytarib bo'lmaydi.
            </p>
        </div>

        <div class="flex flex-col gap-3">
            <button onclick="executeDelete()" class="w-full py-4 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-bold transition-all active:scale-95 shadow-lg shadow-red-100">
                <i class="fa-solid fa-check mr-2"></i><span id="deleteBtnText">O'chirish</span>
            </button>
            <button onclick="closeDeleteSheet()" class="w-full py-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-2xl font-bold transition-all active:scale-95">
                Bekor qilish
            </button>
        </div>
    </div>
</div>
<!-- FULL USER PROFILE OVERLAY -->
<div id="fullUserProfile" class="fixed inset-0 z-[9999] bg-white/90 hidden flex-col animate-slide-up overflow-hidden backdrop-blur-lg">
  
  <!-- PROFILE HEADER -->
  <div class="relative w-full h-[40vh] bg-gray-900 flex items-center justify-center overflow-hidden">
    <!-- BACKGROUND BLUR IMAGE -->
    <img id="bgBlurImg" src="" class="absolute inset-0 w-full h-full object-cover blur-3xl opacity-40 transition-all duration-700">

    <!-- PROFILE CIRCLE -->
    <div id="profileCircle" class="relative w-36 h-36 rounded-full border-4 border-white/50 shadow-2xl overflow-hidden cursor-pointer active:scale-95 transition-all duration-300 z-10" onclick="expandImage()">
      <img id="fullProfileImg" src="" class="w-full h-full object-cover">
    </div>

    <!-- TOP BUTTONS -->
    <div class="absolute top-12 left-4 right-4 flex justify-between z-20">
      <button onclick="closeFullProfile()" class="w-10 h-10 bg-black/20 backdrop-blur-xl text-white rounded-full flex items-center justify-center">
        <i class="fa-solid fa-chevron-left"></i>
      </button>
      <div class="flex gap-2">
        <button onclick="downloadProfileImg()" class="w-10 h-10 bg-black/20 backdrop-blur-xl text-white rounded-full flex items-center justify-center">
          <i class="fa-solid fa-download"></i>
        </button>
        <button onclick="shareUserProfile()" class="w-10 h-10 bg-black/20 backdrop-blur-xl text-white rounded-full flex items-center justify-center">
          <i class="fa-solid fa-share-nodes"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- SCROLLABLE CONTENT -->
  <div id="fullProfileScrollArea" class="flex-1 bg-[#f2f2f7]/95 overflow-y-auto p-4 space-y-4 no-scrollbar">

    <!-- NAME & STATUS -->
    <div class="bg-white rounded-[28px] p-6 text-center shadow-sm">
      <h2 id="fullProfileName" class="text-2xl font-black text-gray-800">...</h2>
      <p id="fullProfileStatus" class="text-blue-500 font-bold text-sm">online</p>
    </div>

    <!-- MEDIA / FILES / LINKS TAB -->
    <div class="bg-white rounded-[28px] overflow-hidden shadow-sm">
      <div class="flex border-b border-gray-50 text-[10px] font-black uppercase tracking-widest text-gray-400">
        <button onclick="switchMediaTab('media', this)" class="flex-1 py-4 text-blue-600 border-b-2 border-blue-600 active-tab">Media</button>
        <button onclick="switchMediaTab('files', this)" class="flex-1 py-4">Fayllar</button>
        <button onclick="switchMediaTab('links', this)" class="flex-1 py-4">Linklar</button>
      </div>
      <div id="sharedMediaContent" class="p-3 grid grid-cols-3 gap-2 min-h-[180px]"></div>
    </div>

    <!-- CONTACT INFO -->
    <div class="bg-white rounded-[28px] shadow-sm divide-y divide-gray-50 overflow-hidden">

      <!-- PHONE ACTION -->
      <div onclick="openPhoneActions()" class="p-5 flex justify-between items-center active:bg-gray-50 cursor-pointer relative">
        <div>
          <p class="text-[10px] text-gray-400 font-black uppercase mb-1">Telefon</p>
          <p id="fullProfilePhone" class="font-bold text-gray-800">+998 00 000 00 00</p>
        </div>
        <i class="fa-solid fa-phone-flip text-blue-500"></i>
      </div>

      <!-- USERNAME -->
      <div onclick="copyInfo('username')" class="p-5 flex justify-between items-center active:bg-gray-50 cursor-pointer">
        <div>
          <p class="text-[10px] text-gray-400 font-black uppercase mb-1">Username</p>
          <p id="fullProfileUsername" class="text-blue-600 font-bold">@user</p>
        </div>
        <i class="fa-solid fa-at text-gray-300"></i>
      </div>

      <!-- BIO -->
      <div class="p-5">
        <p class="text-[10px] text-gray-400 font-black uppercase mb-1">Bio</p>
        <p id="fullProfileBio" class="text-gray-600 text-sm leading-relaxed">...</p>
      </div>
    </div>
  </div>
</div>

<!-- PHOTO VIEWER OVERLAY -->
<div id="photoViewer" class="fixed inset-0 z-[10000] bg-black/95 hidden flex-col animate-fade-in">
  <div class="absolute top-12 left-0 right-0 px-6 flex justify-between items-center z-[10001]">
    <span id="viewerName" class="text-white font-bold">Rasm</span>
    <button onclick="closePhotoViewer()" class="w-10 h-10 bg-white/10 text-white rounded-full flex items-center justify-center backdrop-blur-lg">
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>
  </div>
  <img id="expandedImg" src="" class="w-full h-full object-contain">
</div>

<!-- PHONE ACTION SHEET -->
<div id="phoneActionOverlay" class="sheet-overlay fixed inset-0 bg-black/40 hidden z-[10001]" onclick="closePhoneMenu()"></div>
<div id="phoneActionSheet" class="ios-sheet fixed bottom-0 left-0 right-0 bg-white rounded-t-[28px] shadow-2xl transform translate-y-full transition-all duration-300 z-[10002]">
  <div class="sheet-handle w-12 h-1.5 bg-gray-300 rounded-full mx-auto my-2"></div>
  <div class="p-4 space-y-3">
    <h4 id="actionSheetNumber" class="text-center text-gray-400 text-[10px] font-black uppercase mb-4 tracking-widest">+998 00 000 00 00</h4>
    <a id="callBtn" href="#" class="flex items-center justify-between w-full p-5 bg-gray-50 rounded-3xl active:scale-95 transition">
      <span class="font-bold text-gray-800">Qo'ng'iroq qilish</span>
      <i class="fa-solid fa-phone text-green-500"></i>
    </a>
    <button onclick="copyPhoneNumber()" class="flex items-center justify-between w-full p-5 bg-gray-50 rounded-3xl active:scale-95 transition">
      <span class="font-bold text-gray-800">Nusxa olish</span>
      <i class="fa-solid fa-copy text-blue-500"></i>
    </button>
    <button onclick="closePhoneMenu()" class="w-full p-5 text-red-500 font-black text-center">Bekor qilish</button>
  </div>
</div>
    <script>
        const API = "https://safe-chat-60ot.onrender.com";
        const socket = io(API);
        let currentUser = null;
        let activeChat = null;
        let currentEntityType = 'group';
        let selectedMsgId = null;
        let isEditing = false;
        let currentUploadType = 'file';

        // --- AUTH & CORE ---
        function toggleAuth(isReg) {
            document.getElementById('loginView').classList.toggle('hidden', isReg);
            document.getElementById('registerView').classList.toggle('hidden', !isReg);
        }

async function register() {
    const code = document.getElementById('phoneCode').value;
    const phoneNum = document.getElementById('reg_phone').value.trim();
    const u = document.getElementById('reg_u').value.trim();
    const p = document.getElementById('reg_p').value.trim();

    if(!phoneNum || !u || !p) return alert("Hamma maydonlarni to'ldiring!");

    const fullPhone = code + phoneNum; // Masalan: +998901234567

    try {
        const res = await fetch(`${API}/api/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                phone: fullPhone, 
                username: u + ".connect.uz", 
                password: p 
            })
        });
        const d = await res.json();
        if(res.ok) { 
            alert("Muvaffaqiyatli ro'yxatdan o'tdingiz!"); 
            toggleAuth(false); 
        } else { 
            alert(d.message); 
        }
    } catch(e) { 
        alert("Server bilan ulanishda xato!"); 
    }
}

async function login() {
    let u = document.getElementById('login_u').value.trim();
    const p = document.getElementById('login_p').value.trim();

    // 1ï¸âƒ£ Maydonlar boâ€˜sh boâ€˜lsa
    if (!u || !p) {
        alert("Iltimos, username va parolni to'ldiring!");
        return;
    }

    try {
        // 2ï¸âƒ£ API ga login soâ€˜rovi
        const res = await fetch(`${API}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: u,
                password: p
            })
        });

        const d = await res.json();

        // 3ï¸âƒ£ Login muvaffaqiyatli bo'lsa
        if (res.ok) {
            currentUser = d.username;

            // LocalStorage ga saqlaymiz
            localStorage.setItem("chat_user", d.username);
            if (d.phone) {
                localStorage.setItem("user_phone", d.phone);
            }

            // UI ni yangilash
            document.getElementById("authScreen").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");

            // SOCKET orqali tizimga qoâ€˜shish
            socket.emit("join", { username: d.username });

            // Admin tekshiruvi
            if (typeof checkAdminAccess === "function") {
                checkAdminAccess();
            }

            // Dastlabki yuklanish funksiyasi boâ€˜lsa chaqiramiz
            if (typeof initApp === "function") {
                initApp();
            }

        } else {
            // 4ï¸âƒ£ Noaniq xatoda aniq habar
            alert("Xato: " + (d.message || "Login amalga oshmadi!"));
        }

    } catch (err) {
        // 5ï¸âƒ£ Serverga ulanishda muammo â€” internet yoki API ishlamayapti
        console.error("Ulanish xatosi:", err);
        alert("Server bilan ulanishda xato! Iltimos qayta urinib koâ€˜ring.");
    }
}

// Qidiruv maydonini ochish/yopish
function toggleSearch() {
    const searchContainer = document.getElementById('searchBarContainer');
    searchContainer.classList.toggle('hidden');

    // Agar qidiruv ochilsa, inputga fokus berish
    if(!searchContainer.classList.contains('hidden')) {
        document.getElementById('userSearch').focus();
    }
}

// Universal search (chat, group, channel)
function universalSearch(query) {
    query = query.toLowerCase();

    // Chatlarni filtrlash
    document.querySelectorAll('#chatList .chat-item').forEach(chat => {
        chat.style.display = chat.innerText.toLowerCase().includes(query) ? '' : 'none';
    });

    // Guruhlarni filtrlash
    document.querySelectorAll('#groupList .group-item').forEach(group => {
        group.style.display = group.innerText.toLowerCase().includes(query) ? '' : 'none';
    });

    // Kanallarni filtrlash
    document.querySelectorAll('#channelsTab .channel-item').forEach(channel => {
        channel.style.display = channel.innerText.toLowerCase().includes(query) ? '' : 'none';
    });
}

function updateNavUI(tabName) {
    const btn = document.getElementById(`nav-${tabName}`);
    const indicator = document.getElementById('navIndicator');
    if (btn && indicator) {
        indicator.style.width = `${btn.offsetWidth}px`;
        indicator.style.left = `${btn.offsetLeft}px`;
    }
}

function switchTab(tab) {
    // 1. Navigatsiya tugmalarining vizual holatini yangilash (Ranglar)
    document.querySelectorAll('.nav-item').forEach(i => {
        i.classList.remove('text-[#007aff]');
        i.classList.add('text-gray-400');
    });

    // 2. Tanlangan navigatsiya tugmasini aktiv (ko'k) qilish
    const navBtn = document.getElementById(`nav-${tab}`);
    if (navBtn) {
        navBtn.classList.remove('text-gray-400');
        navBtn.classList.add('text-[#007aff]');

        // iOS uslubidagi ko'k indikatorni harakatlantirish
        const indicator = document.getElementById('navIndicator');
        if (indicator) {
            indicator.style.width = `${navBtn.offsetWidth}px`;
            indicator.style.left = `${navBtn.offsetLeft}px`;
        }
    }

    // 3. Tab kontentlarini almashtirish (Hidden/Visible)
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const tabCont = document.getElementById(`${tab}Tab`);
    if (tabCont) {
        tabCont.classList.remove('hidden');
    }

    // 4. Yuqori sarlavha (Header Title) matnini yangilash
    const titles = { 
        chats: 'Chatlar', 
        groups: 'Ommaviy', 
        profile: 'Profil', 
        settings: 'Sozlamalar' 
    };

    const titleEl = document.getElementById('tabTitle');
    if (titleEl) {
        titleEl.innerText = titles[tab] || 'SafeChat';
    }

    // 5. Chatlar va Guruhlar bo'limi uchun ro'yxatni yuklash
    if (tab === 'chats' || tab === 'groups') {
        if (typeof loadList === 'function') {
            loadList(tab);
        }
    } 
    
    // 6. Profil va Sozlamalar bo'limi uchun barcha ma'lumotlarni yangilash
    if (tab === 'profile' || tab === 'settings') {
        
        // --- Siz so'ragan asosiy yangilash funksiyalari ---
        if (typeof updateAllUI === 'function') {
            updateAllUI(); // Barcha matnlar, ism, bio va rasmlarni yuklash
        }

        if (typeof updateDeviceInfo === 'function') {
            updateDeviceInfo(); // Faol seanslar (Devices) ro'yxatini yuklash
        }

        // --- Qo'shimcha Premium funksiyalar ---
        if (typeof loadStatus === 'function') {
            loadStatus(); // Foydalanuvchi statusini yuklash
        }

        if (typeof updateProfileUI === 'function') {
            updateProfileUI(); // Eski mantiqdan qolgan UI yangilanishi
        }

        if (typeof checkAdminAccess === 'function') {
            checkAdminAccess(); // Admin huquqlarini tekshirish
        }
    }

    // 7. Navigatsiya UI qo'shimcha yangilanishi (FaceID/PIN holati)
    if (typeof updateNavUI === 'function') {
        updateNavUI(tab);
    }

    // 8. Yashirin chatlar uchun PIN lock belgisini boshqarish
    if (tab === 'chats') {
        const lockIcon = document.getElementById('lockStatusIcon');
        if (lockIcon) {
            // Agar PIN o'rnatilgan bo'lsa qulf belgisini ko'rsatish
            const hasPin = localStorage.getItem("hiddenPin");
            if (hasPin) {
                lockIcon.classList.remove('hidden');
            } else {
                lockIcon.classList.add('hidden');
            }
        }
    }

    // Konsolga ma'lumot chiqarish (Tekshirish uchun)
    console.log(`[SafeChat] Tab switched to: ${tab}`);
}


async function loadList(tab) {
    // 1. To'g'ri konteynerni tanlash
    let list;
    if (tab === 'chats') {
        list = document.getElementById('chatList');
    } else {
        list = document.getElementById(`${tab}Tab`);
    }

    if (!list) return;

    // Yuklanish indikatori
    if (list.innerHTML.trim() === "" || list.innerHTML.includes('text-red-400')) {
        list.innerHTML = `
            <div class="flex flex-col items-center justify-center py-20 animate-pulse">
                <div class="w-16 h-16 bg-gray-200 rounded-full mb-4"></div>
                <div class="h-3 w-32 bg-gray-200 rounded mb-2"></div>
                <div class="h-2 w-20 bg-gray-100 rounded"></div>
            </div>`;
    }

    try {
        if (tab === 'chats') {
            const res = await fetch(`${API}/api/recent_chats?username=${currentUser}`);
            const contacts = await res.json();
            list.innerHTML = ""; 

            if (!contacts || contacts.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-60 animate-fade-in text-center">
                        <div class="w-20 h-20 bg-blue-50 rounded-[30px] flex items-center justify-center mb-4">
                            <i class="fa-solid fa-comments text-3xl text-blue-500"></i>
                        </div>
                        <p class="text-gray-800 text-sm font-bold">Suhbatlar hali yo'q</p>
                        <p class="text-gray-400 text-[11px] px-10">Kimnidir topish uchun qidiruvdan foydalaning.</p>
                    </div>`;
            } else {
                contacts.forEach(contact => {
                    const name = typeof contact === 'object' ? contact.username : contact;
                    const isOnline = typeof contact === 'object' ? contact.is_online : false;
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-4 bg-white rounded-2xl cursor-pointer hover:bg-blue-50 transition-all duration-300 shadow-sm mb-2 active:scale-[0.97] border border-gray-50 group animate-fade-in";
                    
                    div.innerHTML = `
                        <div class="relative">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007aff&color=fff" class="w-13 h-13 rounded-full border-2 border-white shadow-sm">
                            ${isOnline ? '<div class="absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <h5 class="font-bold text-[14px] text-gray-800 truncate">${name}</h5>
                                <span class="text-[10px] text-gray-400">Hozir</span>
                            </div>
                            <div class="flex justify-between items-center text-[12px]">
                                <p class="text-gray-400 truncate pr-4">Suhbatni boshlash...</p>
                                <div class="w-2 h-2 bg-blue-600 rounded-full ${typeof contact === 'object' && contact.unread ? '' : 'hidden'}" id="unread-${name}"></div>
                            </div>
                        </div>
                    `;

                    // --- O'CHIRISH FUNKSIYALARI (CHATS) ---
                    let pressTimer;
                    let isLongPress = false;

                    // O'ng tugma (Desktop)
                    div.oncontextmenu = (e) => {
                        e.preventDefault();
                        openDeleteActionSheet(name, 'chat');
                    };

                    // Uzoq bosish (Mobile)
                    const startPress = () => {
                        isLongPress = false;
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            openDeleteActionSheet(name, 'chat');
                        }, 800);
                    };
                    const cancelPress = () => clearTimeout(pressTimer);

                    div.addEventListener('touchstart', startPress);
                    div.addEventListener('touchend', cancelPress);
                    div.addEventListener('mousedown', startPress);
                    div.addEventListener('mouseup', cancelPress);

                    div.onclick = () => {
                        if (!isLongPress) openChat(name);
                    };
                    list.appendChild(div);
                });
            }
        } else if (tab === 'groups') {
            const res = await fetch(`${API}/api/entities?username=${currentUser}`);
            const entities = await res.json();
            list.innerHTML = ""; 

            if (!entities || entities.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-60 animate-fade-in text-center">
                        <div class="w-20 h-20 bg-orange-50 rounded-[30px] flex items-center justify-center mb-4">
                            <i class="fa-solid fa-globe text-3xl text-orange-500"></i>
                        </div>
                        <p class="text-gray-800 text-sm font-bold">Hech narsa topilmadi</p>
                        <p class="text-gray-400 text-[11px] mb-4">Hozircha ommaviy guruhlar mavjud emas.</p>
                        <button onclick="openSheet('createEntitySheet')" class="bg-blue-600 text-white px-6 py-2 rounded-full text-xs font-bold shadow-lg shadow-blue-200">YARATISH</button>
                    </div>`;
            } else {
                entities.forEach(ent => {
                    const isGroup = ent.type === 'group';
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-4 p-4 bg-white rounded-3xl cursor-pointer hover:bg-gray-50 transition-all duration-300 shadow-sm mb-3 active:scale-[0.97] border border-gray-100 mx-4 animate-fade-in";
                    
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br ${isGroup ? 'from-blue-500 to-indigo-600' : 'from-purple-500 to-pink-600'} flex items-center justify-center text-white text-2xl shadow-lg relative overflow-hidden">
                            <div class="absolute inset-0 bg-white/10 opacity-20 transform rotate-12 translate-y-4"></div>
                            <i class="fa-solid ${isGroup ? 'fa-users' : 'fa-bullhorn'} relative z-10"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-black text-[15px] text-gray-800 truncate">${ent.name}</h3>
                                <span class="bg-gray-100 text-[9px] font-black px-2 py-1 rounded-md text-gray-500 uppercase tracking-tighter">
                                    ${isGroup ? 'Guruh' : 'Kanal'}
                                </span>
                            </div>
                            <p class="text-[11px] text-gray-400 font-medium">
                                <i class="fa-solid fa-circle-check text-blue-400 mr-1"></i>
                                ${ent.member_count || 0} a'zo â€¢ ${isGroup ? 'Suhbatlashish' : 'Obuna'}
                            </p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-300">
                            <i class="fa-solid fa-chevron-right text-[10px]"></i>
                        </div>
                    `;

                    // --- O'CHIRISH FUNKSIYALARI (GROUPS/CHANNELS) ---
                    let groupTimer;
                    let groupLongPress = false;

                    div.oncontextmenu = (e) => {
                        e.preventDefault();
                        openDeleteActionSheet(ent.name, 'group');
                    };

                    const gStart = () => {
                        groupLongPress = false;
                        groupTimer = setTimeout(() => {
                            groupLongPress = true;
                            openDeleteActionSheet(ent.name, 'group');
                        }, 800);
                    };
                    const gCancel = () => clearTimeout(groupTimer);

                    div.addEventListener('touchstart', gStart);
                    div.addEventListener('touchend', gCancel);
                    div.addEventListener('mousedown', gStart);
                    div.addEventListener('mouseup', gCancel);

                    div.onclick = () => {
                        if (!groupLongPress) openChat(ent.name);
                    };
                    list.appendChild(div);
                });
            }
        }
    } catch (e) {
        console.error("Xatolik:", e);
        list.innerHTML = `<div class="text-center py-10 text-red-500 font-bold text-xs"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Ulanishda xato yuz berdi!</div>`;
    }
}

// QIDIRUV FUNKSIYASI (O'zgarishsiz qoladi, lekin openChat ni to'g'ri chaqiradi)
const toggleBtn = document.getElementById('toggleSearch');
    const searchWrapper = document.getElementById('searchWrapper');

    toggleBtn.addEventListener('click', () => {
        // Qidiruv oynasini ochish/yopish
        searchWrapper.classList.toggle('hidden');
        // focus input, agar ochilgan bo'lsa
        if(!searchWrapper.classList.contains('hidden')){
            document.getElementById('userSearch').focus();
        }
    });

    // QIDIRUV FUNKSIYASI (o'zgarmadi)
    async function liveSearch(val) {
        const list = document.getElementById('chatList');
        if (val.length < 1) { loadList('chats'); return; }

        try {
            const res = await fetch(`${API}/api/users/search`);
            const users = await res.json();
            const filtered = users.filter(u => u.username.toLowerCase().includes(val.toLowerCase()) && u.username !== currentUser);

            list.innerHTML = "";
            if(filtered.length === 0) {
                list.innerHTML = `<p class="text-center text-red-400 mt-10 text-sm">Foydalanuvchi topilmadi</p>`;
                return;
            }

            filtered.forEach(u => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-4 bg-white rounded-2xl cursor-pointer hover:bg-blue-50 transition shadow-sm mb-2 active:scale-95";
                div.innerHTML = `
                    <img src="https://ui-avatars.com/api/?name=${u.username}&background=007aff&color=fff" class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <h5 class="font-bold text-sm text-gray-800">${u.username}</h5>
                        <p class="text-[10px] text-blue-500 font-medium">Yangi suhbat boshlash</p>
                    </div>
                `;
                div.onclick = () => openChat(u.username);
                list.appendChild(div);
            });
        } catch(e) { console.error("Search error", e); }
    }

    // O'chirilayotgan narsani vaqtinchalik saqlash
let currentDeleteTarget = { name: '', type: '' };

// Menyuni ochish
function openDeleteActionSheet(name, type) {
    currentDeleteTarget = { name, type };
    const sheet = document.getElementById('deleteActionSheet');
    
    // Matnlarni to'g'rilash
    document.getElementById('deleteTargetName').innerText = name;
    document.getElementById('deleteBtnText').innerText = (type === 'chat') ? "Chatni o'chirish" : "Guruhdan chiqish";
    
    // Ko'rsatish
    sheet.classList.remove('hidden');
    
    // Haptic feedback (Mobil qurilmalarda tebranish)
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(40);
    }
}

// Menyuni yopish
function closeDeleteSheet() {
    document.getElementById('deleteActionSheet').classList.add('hidden');
}

// O'chirishni amalga oshirish
async function executeDelete() {
    // currentTarget bu yerda {name: '...', type: '...'} shaklida bo'lishi kerak
    if (!currentTarget.name) return;

    try {
        const res = await fetch(`${API}/api/delete_entity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser, // localStorage.getItem('username')
                target: currentTarget.name,
                type: currentTarget.type
            })
        });

        // Server javob bermasa (masalan 404 yoki 500), res.ok false bo'ladi
        if (!res.ok) throw new Error('Server xatosi');

        const data = await res.json();
        
        if (data.success) {
            closeDeleteSheet();
            // Ro'yxatni yangilash
            loadList(currentTarget.type === 'chat' ? 'chats' : 'groups');
            // Muvaffaqiyat xabari (ixtiyoriy)
            console.log(data.message);
        } else {
            alert("Xatolik: " + data.message);
        }
    } catch (e) {
        console.error("Fetch xatosi:", e);
        alert("Server bilan ulanishda xato!");
    }
}

async function openChat(name) {
    activeChat = name;
    const chatArea = document.getElementById('chatArea');
    
    // 1. Chat oynasini ko'rinadigan qilish (CSS dagi display: none ni yengish uchun)
    chatArea.style.display = 'flex'; 
    chatArea.classList.remove('hidden');
    
    // 2. Suhbatdosh ma'lumotlarini yangilash
    document.getElementById('activeName').innerText = name;
    document.getElementById('activeChatImg').src = `https://ui-avatars.com/api/?name=${name}&background=007aff&color=fff`;
    
    // Xabarlar oynasini tozalash va yuklanayotganini ko'rsatish (ixtiyoriy)
    const msgBox = document.getElementById('msgBox');
    msgBox.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs">Yuklanmoqda...</div>'; 
    
    // 3. Xabarlar tarixini serverdan yuklash
    try {
        const res = await fetch(`${API}/api/messages?user1=${currentUser}&user2=${name}`);
        if (res.ok) {
            const msgs = await res.json();
            msgBox.innerHTML = ""; // Yuklanmoqda yozuvini o'chirish
            if(msgs.length === 0) {
                msgBox.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs">Xabarlar mavjud emas</div>';
            } else {
                msgs.forEach(appendMessage);
            }
        }
    } catch(e) { 
        console.log("Xabarlarni yuklashda xato:", e);
        msgBox.innerHTML = '<div class="text-center py-10 text-red-400 text-xs">Xabarlarni yuklab bo\'lmadi</div>';
    }

    // 4. Ochiq turgan barcha menyularni yopish
    closeAllSheets();
}
/////menuni tepaga chiqaradi 
function fixMobileHeight() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('resize', fixMobileHeight);
window.addEventListener('load', fixMobileHeight);
fixMobileHeight();

function sendMsg(type = 'text', content = null) {
    const inp = document.getElementById('msgInp');
    const val = content || inp.value.trim();
    
    // Agar xabar bo'sh bo'lsa yoki chat tanlanmagan bo'lsa chiqib ketish
    if (!val || !activeChat) return;

    if (isEditing) {
        // --- TAHRIRLASH REJIMI ---
        socket.emit('edit_message', { 
            id: selectedMsgId, 
            content: val, 
            receiver: activeChat 
        });
        
        // Tahrirlashni yakunlash va tugma ikonkasini qaytarish
        isEditing = false;
        selectedMsgId = null; 
        document.getElementById('sendBtnIcon').className = "fa-solid fa-arrow-up";
        
    } else {
        // --- YANGI XABAR YUBORISH REJIMI ---
        const data = { 
            sender: currentUser, 
            receiver: activeChat, 
            content: val, 
            // Reply ma'lumotlarini qo'shish
            reply_to: replyToId ? { 
                id: replyToId, 
                text: replyToText, 
                sender: replyToSender 
            } : null,
            type: type 
        };

        // Serverga yuborish
        socket.emit('send_message', data);
        
        // --- MUHIM: Reply rejimini tozalash ---
        if (replyToId) {
            cancelReply(); // Reply oynasini yopish va o'zgaruvchilarni nolga tushirish
        }
    }
    
    // Inputni tozalash va fokusni qaytarish
    if (!content) {
        inp.value = "";
        inp.focus();
    }
}

function updateHeight() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('resize', updateHeight);
window.addEventListener('load', updateHeight);
updateHeight();

let pressTimer;
let currentTarget = { name: '', type: '' };

function setupLongPress(element, name, type) {
    // Mobil va Desktop uchun hodisalar
    ['touchstart', 'mousedown'].forEach(evt => {
        element.addEventListener(evt, (e) => {
            pressTimer = setTimeout(() => {
                showActionSheet(name, type);
            }, 700); // 0.7 soniya bosib tursa
        });
    });

    ['touchend', 'mouseup', 'mouseleave'].forEach(evt => {
        element.addEventListener(evt, () => clearTimeout(pressTimer));
    });
}

function showActionSheet(name, type) {
    currentTarget = { name, type };
    const sheet = document.getElementById('deleteActionSheet');
    const title = document.getElementById('deleteTargetName');
    const btnText = document.getElementById('deleteBtnText');

    title.innerText = name;
    btnText.innerText = type === 'chat' ? "Chatni o'chirish" : "Guruhdan chiqish";
    
    sheet.classList.remove('hidden');
    if (window.navigator.vibrate) window.navigator.vibrate(50);
}

function appendMessage(data) {
    const box = document.getElementById('msgBox');
    const isMe = data.sender === currentUser;
    
    // 1. Multimedia qismini tayyorlash
    let mediaHTML = "";
    if (data.type === 'image') {
        mediaHTML = `<img src="${data.file_data || data.content}" class="max-w-full rounded-lg cursor-pointer mb-2 shadow-sm" onclick="viewImage(this.src)">`;
    } else if (data.type === 'video') {
        mediaHTML = `<video src="${data.file_data}" controls class="max-w-full rounded-lg mb-2 shadow-sm"></video>`;
    } else if (data.type === 'location') {
        mediaHTML = `
            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 mb-2">
                <a href="${data.content}" target="_blank" class="text-blue-600 text-sm flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-map-location-dot"></i> ðŸ“ Joylashuvni ko'rish
                </a>
            </div>`;
    }

    // 2. Matn (kontent) qismini tayyorlash
    // Agar bu location bo'lsa, linkni matn sifatida qayta ko'rsatmaymiz
    let textHTML = (data.type !== 'location' && data.content && data.content.trim() !== "") 
                   ? `<p class="text-sm leading-relaxed">${data.content}</p>` 
                   : "";

    // 3. Reply (javob) qismi
    let replyMarkup = "";
    if (data.reply_to) {
        replyMarkup = `
            <div class="bg-black/5 border-l-2 border-blue-500 p-1.5 mb-2 rounded text-[11px] opacity-80 cursor-pointer" onclick="scrollToMessage('${data.reply_to.id}')">
                <b class="text-blue-600 block">${data.reply_to.sender}</b>
                <p class="truncate text-gray-600">${data.reply_to.text}</p>
            </div>`;
    }

    // 4. Konteyner yaratish
    const container = document.createElement('div');
    container.id = `container-${data.id}`;
    container.className = `msg-container flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-3 px-4 w-full`;
    
    container.innerHTML = `
        <div class="msg-bubble relative max-w-[85%] p-2.5 rounded-2xl shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'}" 
            id="msg-${data.id}">
            ${replyMarkup}
            <div class="msg-body">
                ${mediaHTML}
                ${textHTML}
            </div>
            <div class="flex items-center justify-end gap-1 mt-1 opacity-60">
                <span class="text-[9px]">${data.timestamp}</span>
                ${isMe ? '<i class="fa-solid fa-check-double text-[8px]"></i>' : ''}
            </div>
        </div>
    `;

    box.appendChild(container);
    
    // 5. Hodisalarni bog'lash
    const bubble = container.querySelector('.msg-bubble');
    bindContextEvents(bubble, data); 
    initSwipe(bubble, data.id, data.content, data.sender);
    
    // Skrolni pastga tushirish
    box.scrollTop = box.scrollHeight;
}
function refreshProfileUI() {
    const name = localStorage.getItem('username') || 'Foydalanuvchi';
    const phone = localStorage.getItem('user_phone') || '+998 -- --- -- --';
    const bio = localStorage.getItem('user_bio') || 'Bio hali yozilmagan...';

    // Inputlar
    document.getElementById('editNameInp').value = name;
    document.getElementById('editBioInp').value = bio === 'Bio hali yozilmagan...' ? '' : bio;
    
    // Matnlar
    document.getElementById('profileNameDisplay').innerText = name;
    document.getElementById('profilePhoneDisplay').innerText = phone;
    document.getElementById('displayUsername').innerText = '@' + name.toLowerCase().replace(/\s/g, '_');
    document.getElementById('displayBio').innerText = bio;

    // Avatar
    const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007aff&color=fff&size=128`;
    document.getElementById('profileDisplayPic').src = avatar;
    document.getElementById('userAvatar').src = avatar;
}


        // --- CONTEXT MENU ACTIONS ---
        function showContextMenu(e, msgId) {
            selectedMsgId = msgId;
            const menu = document.getElementById('msgContextMenu');
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px';
            document.getElementById('sheetOverlay').classList.add('active');
        }

        function copyMsg() {
            const txt = document.getElementById(`msg-${selectedMsgId}`).innerText;
            navigator.clipboard.writeText(txt);
            closeAllSheets();
        }

        function startEditMsg() {
            isEditing = true;
            const txt = document.getElementById(`msg-${selectedMsgId}`).innerText;
            document.getElementById('msgInp').value = txt;
            document.getElementById('msgInp').focus();
            document.getElementById('sendBtnIcon').className = "fa-solid fa-check";
            closeAllSheets();
        }

        function deleteMsgServer() {
            socket.emit('delete_message', { id: selectedMsgId, receiver: activeChat });
            document.getElementById(`msg-${selectedMsgId}`).remove();
            closeAllSheets();
        }

// --- MEDIA & TOOLS ---

let pendingFileData = null;
let pendingFileType = null;

// 1. Fayl tanlash
function triggerMediaUpload(type) {
    const input = document.createElement('input');
    input.type = 'file';
    if (type === 'image') input.accept = 'image/*';
    else if (type === 'video') input.accept = 'video/*';
    else input.accept = '*/*';

    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            pendingFileData = event.target.result; // Base64
            pendingFileType = type;
            showMediaPreview(pendingFileData, type);
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

const countries = [
    { name: "Uzbekistan", code: "+998", flag: "ðŸ‡ºðŸ‡¿" },
    { name: "Russia", code: "+7", flag: "ðŸ‡·ðŸ‡º" },
    { name: "USA", code: "+1", flag: "ðŸ‡ºðŸ‡¸" },
    { name: "Turkey", code: "+90", flag: "ðŸ‡¹ðŸ‡·" },
    { name: "Kazakhstan", code: "+7", flag: "ðŸ‡°ðŸ‡¿" },
    { name: "Germany", code: "+49", flag: "ðŸ‡©ðŸ‡ª" },
    { name: "United Kingdom", code: "+44", flag: "ðŸ‡¬ðŸ‡§" },
    { name: "South Korea", code: "+82", flag: "ðŸ‡°ðŸ‡·" },
    { name: "Kyrgyzstan", code: "+996", flag: "ðŸ‡°ðŸ‡¬" },
    { name: "Tajikistan", code: "+992", flag: "ðŸ‡¹ðŸ‡¯" }
];

function openCountryModal() {
    document.getElementById('countryModal').classList.remove('hidden');
    renderCountries(countries);
}

function closeCountryModal() {
    document.getElementById('countryModal').classList.add('hidden');
}

function renderCountries(list) {
    const container = document.getElementById('countryList');
    container.innerHTML = "";
    list.forEach(c => {
        const item = document.createElement('div');
        item.className = "flex items-center justify-between p-4 border-b hover:bg-gray-50 cursor-pointer transition";
        item.innerHTML = `
            <div class="flex items-center gap-4">
                <span class="text-2xl">${c.flag}</span>
                <span class="font-medium text-gray-700">${c.name}</span>
            </div>
            <span class="text-gray-400 font-bold">${c.code}</span>
        `;
        item.onclick = () => {
            document.getElementById('selectedFlag').innerText = c.flag;
            document.getElementById('selectedCountryName').innerText = c.name;
            document.getElementById('phoneCode').value = c.code;
            closeCountryModal();
        };
        container.appendChild(item);
    });
}

function filterCountries() {
    const term = document.getElementById('countrySearch').value.toLowerCase();
    const filtered = countries.filter(c => c.name.toLowerCase().includes(term));
    renderCountries(filtered);
}

// 2. Preview oynasini ochish
function showMediaPreview(data, type) {
    const modal = document.getElementById('mediaPreviewModal');
    const display = document.getElementById('mediaDisplayArea');
    modal.classList.remove('hidden');

    if (type === 'image') {
        display.innerHTML = `<img src="${data}" class="max-w-full max-h-[60vh] rounded-lg shadow-2xl">`;
    } else if (type === 'video') {
        display.innerHTML = `<video src="${data}" controls class="max-w-full max-h-[60vh] rounded-lg"></video>`;
    }
}

function closeMediaPreview() {
    document.getElementById('mediaPreviewModal').classList.add('hidden');
    pendingFileData = null;
}

// 1. Hisob ma'lumotlarini yangilash
function updateAccountInfo() {
    const newName = document.getElementById('editNameInp').value;
    const newBio = document.getElementById('editBioInp').value;

    if (newName.trim()) {
        localStorage.setItem('username', newName);
        localStorage.setItem('user_bio', newBio);
        
        // UI ni darhol yangilash
        document.getElementById('profileNameDisplay').innerText = newName;
        document.getElementById('displayUsername').innerText = '@' + newName.toLowerCase().replace(/\s/g, '_');
        
        alert("Ma'lumotlar saqlandi!");
    }
}

function clearCache() {
    if (confirm("Keshni tozalamoqchimisiz? Bu rasmlarni qayta yuklanishiga sabab bo'ladi.")) {
        document.getElementById('cacheSize').innerText = "0.0 MB";
        alert("Kesh muvaffaqiyatli tozalandi!");
    }
}

// 3. Tasdiqlash va Yuborish
function confirmAndSendMedia() {
    if (!pendingFileData) return;
    
    const caption = document.getElementById('mediaCaption').value;
    
    const data = {
        sender: currentUser,
        receiver: activeChat,
        content: caption || (pendingFileType === 'image' ? "ðŸ–¼ Rasm" : "ðŸ“¹ Video"),
        file_data: pendingFileData,
        type: pendingFileType,
        reply_to: replyToId ? { id: replyToId, text: replyToText, sender: replyToSender } : null,
        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };

    socket.emit('send_message', data);
    
    // Tozalash
    closeMediaPreview();
    document.getElementById('mediaCaption').value = "";
    cancelReply(); // Agar reply bo'lsa
}

// 4. Location yuborish (Preview shart emas, birdan ketadi)
function sendLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const locData = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            socket.emit('send_message', {
                sender: currentUser,
                receiver: activeChat,
                type: 'location',
                content: `Joylashuv: ${locData.lat}, ${locData.lng}`,
                location: locData // Serverga obyekt sifatida yuboramiz
            });
            closeSheet('mediaSheet');
        });
    } else {
        alert("Geolokatsiya qurilmangizda qo'llab-quvvatlanmaydi.");
    }
}
        function setEntityType(type) {
            currentEntityType = type;
            document.getElementById('btnTypeGroup').classList.toggle('bg-white', type === 'group');
            document.getElementById('btnTypeChannel').classList.toggle('bg-white', type === 'channel');
        }

        function submitNewEntity() {
            const name = document.getElementById('entityName').value;
            socket.emit('create_entity', { type: currentEntityType, name, creator: currentUser });
            alert(name + " yaratildi!");
            closeAllSheets();
        }

                    socket.on("entity_created", (data) => {
                if (data.type === "group") {
                    addToGroupList(data.name);
                } else {
                    addToChannelList(data.name);
                }
            });

        function openUserMenu() {
            const block = confirm(activeChat + " foydalanuvchini bloklash?");
            if(block) socket.emit('block_user', { target: activeChat });
        }

        function initiateCall(type) {
            alert(type + " qo'ng'iroq signali yuborilmoqda...");
            socket.emit('call_signal', { to: activeChat, type: type });
        }
        // guruh va kanallar qoshish uchun yangi funksiya 
        let entityType = "group"; // default

function setEntityType(type) {
    entityType = type;

    document.getElementById("btnTypeGroup").classList.toggle("bg-white", type === "group");
    document.getElementById("btnTypeGroup").classList.toggle("text-gray-800", type === "group");
    document.getElementById("btnTypeGroup").classList.toggle("text-gray-500", type !== "group");

    document.getElementById("btnTypeChannel").classList.toggle("bg-white", type === "channel");
    document.getElementById("btnTypeChannel").classList.toggle("text-gray-800", type === "channel");
    document.getElementById("btnTypeChannel").classList.toggle("text-gray-500", type !== "channel");
}

function createEntity() {
    const name = document.getElementById("entityName").value.trim();
    if (name.length < 2) {
        alert("Nomi juda qisqa!");
        return;
    }

    // Backendga yuboriladi
    socket.emit("create_entity", { 
        type: entityType,
        name: name 
    });

    // UIga qoâ€˜shib qoâ€˜yamiz (real vaqtda koâ€˜rinishi uchun)
    if (entityType === "group") {
        addToGroupList(name);
    } else {
        addToChannelList(name);
    }

    closeSheet();
}

// Frontendga yangi element qoâ€˜shish
function addToGroupList(name) {
    const box = document.getElementById("groupsTab");
    box.innerHTML += `
        <div class="p-4 bg-white rounded-2xl shadow-sm">
            <h3 class="text-lg font-bold">${name}</h3>
            <p class="text-gray-500 text-sm">Yangi guruh</p>
        </div>
    `;
}

function addToChannelList(name) {
    const box = document.getElementById("channelsTab");
    box.innerHTML += `
        <div class="p-4 bg-white rounded-2xl shadow-sm">
            <h3 class="text-lg font-bold">${name}</h3>
            <p class="text-gray-500 text-sm">Yangi kanal</p>
        </div>
    `;
}

function createEntity() {
    const type = currentEntityType; 
    const name = document.getElementById("entityName").value.trim();

    if (!name) return alert("Nomi boâ€˜sh boâ€˜lmasin!");

    socket.emit("create_entity", {
        type: type,
        name: name
    });

    closeSheet('createEntitySheet');
    document.getElementById("entityName").value = "";
}

// --- UI HELPERS (YANGILANGAN) ---
        function openSheet(id) { 
            document.getElementById(id).classList.add('active'); 
            document.getElementById('sheetOverlay').classList.add('active'); 
        }

        function closeSheet(id) { 
            document.getElementById(id).classList.remove('active'); 
            document.getElementById('sheetOverlay').classList.remove('active'); 
        }

        function closeAllSheets() {
            // Hamma sheetlarni yopish
            document.querySelectorAll('.ios-sheet').forEach(s => s.classList.remove('active'));
            // Overlayni yopish
            document.getElementById('sheetOverlay').classList.remove('active');
            // Kontekst menyuni yashirish
            document.getElementById('msgContextMenu').style.display = 'none';
        }

        function handleEnter(e) { 
            if(e.key === 'Enter') sendMsg(); 
        }
        function handleReply() {
        setupReply(selectedMsgId, selectedMsgText, selectedMsgSender);
        closeMenu(); // BU MUHIM!
        }

        // 1. CHATNI YOPISH FUNKSIYASI
function closeChatArea() { 
    const chatArea = document.getElementById('chatArea');
    chatArea.style.display = 'none'; 
    chatArea.classList.add('hidden'); 
    chatArea.classList.remove('flex');
    activeChat = null; 
    
    const searchInp = document.querySelector('input[type="search"]');
    if(searchInp) searchInp.value = "";
}

// 2. ADMIN LOGIN FUNKSIYASI
function showAdminLogin() {
    const key = prompt("ENTER ROOT_KEY:");
    if (key === 'serinaqu') {
        const panel = document.getElementById('adminPanel');
        panel.style.display = 'block';
        panel.classList.remove('hidden');
        loadAdminData();
        addLog("ADMIN_SESSION_STARTED", "success");
    } else {
        alert("ACCESS_DENIED: INVALID_KEY");
    }
}

// 3. ADMIN PANELNI YOPISH
function closeAdmin() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = 'none';
    panel.classList.add('hidden');
}

// 4. ADMIN LOG QO'SHISH
function addLog(msg, type = "info") {
    const logContainer = document.getElementById('adminLogs');
    if(!logContainer) return;
    const time = new Date().toLocaleTimeString();
    const color = type === "success" ? "text-green-400" : type === "danger" ? "text-red-500" : "text-blue-400";
    logContainer.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 5. ADMIN DATA YUKLASH
async function loadAdminData() {
    try {
        const response = await fetch(`${API}/api/admin/users`);
        const users = await response.json();
        const table = document.getElementById('adminTable');
        if(!table) return;
        table.innerHTML = "";
        
        users.forEach(u => {
            const row = `
                <tr class="hover:bg-green-900/20 transition-colors border-b border-green-900/30">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3">USER</td>
                    <td class="p-3">
                        <span class="w-2 h-2 inline-block rounded-full ${u.status === 'ONLINE' ? 'bg-green-500' : 'bg-gray-600'} mr-2"></span>
                        ${u.status}
                    </td>
                    <td class="p-3 ${u.is_blocked ? 'text-red-500' : 'text-green-500'}">${u.is_blocked ? 'BANNED' : 'CLEAR'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="toggleBan('${u.name}')" class="bg-red-900/50 border border-red-700 px-2 py-1 rounded text-[10px] hover:bg-red-700">BAN/UNBAN</button>
                    </td>
                </tr>`;
            table.innerHTML += row;
        });
        document.getElementById('totalUsersStat').innerText = users.length;
    } catch(e) { 
        addLog("DATA_LOAD_FAILED", "danger"); 
    }
}

// 6. E'LONNI CHIQARISH (BROADCAST)
function publishAnnouncement() {
    const type = document.getElementById('advType').value;
    const value = document.getElementById('advValue').value;
    const start = document.getElementById('advStart').value;
    const end = document.getElementById('advEnd').value;

    if(!value) return alert("E'lon matni yoki linkini kiriting!");

    const config = { type, value, start, end };
    socket.emit('broadcast_announcement', config);
    addLog(`BROADCAST_DEPLOYED: ${type}`, "success");
    alert("E'lon barcha foydalanuvchilarga yuborildi!");
}

        // TIZIMDAN CHIQISH (To'liq tozalash bilan)
        function logout() {
            if(confirm("Tizimdan chiqmoqchimisiz?")) {
                currentUser = null;
                activeChat = null;
                // Sahifani qayta yuklash orqali barcha o'zgaruvchilarni nolga tushiramiz
                window.location.reload(); 
            }
        }

        // PROFILNI SAQLASH TUGMASI UCHUN
        function saveProfile() {
            alert("Profil ma'lumotlari muvaffaqiyatli saqlandi!");
            closeSheet('settingsSheet');
        }
        // Foydalanuvchi login qilgandan keyin bu ishga tushadi
        function onUserLoggedIn() {
            currentUser = localStorage.getItem('chat_user'); // Agar saqlangan bo'lsa
            if(currentUser) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                switchTab('chats'); // Birinchi bo'lib chatlar bo'limi ochiladi
            }
        }
// --- SOCKET REAL-TIME ---

// 1. Ovozli xabarnoma fayli (Istalgan qisqa mp3 linkini qo'yishingiz mumkin)
const msgSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

// --- SOCKET REAL-TIME ---

socket.on('receive_message', (data) => {
    console.log("Yangi xabar keldi:", data);

    // 1. Ovoz va Titrash (Agar xabar sizdan chiqmagan bo'lsa)
    if (data.sender !== currentUser) {
        msgSound.play().catch(e => console.error("Ovoz xatosi:", e));
        if (navigator.vibrate) navigator.vibrate(200);
    }

    // 2. Chat oynasini yangilash
    // Shart: Agar hozirgi ochiq suhbatdoshimiz xabar yuborgan bo'lsa YOKI biz yuborgan bo'lsak
    if (activeChat === data.sender || (activeChat === data.receiver && data.sender === currentUser)) {
        appendMessage(data);
        
        // Xabarlar oynasini avtomatik pastga tushirish
        const msgBox = document.getElementById('msgBox');
        if (msgBox) {
            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });
        }
    } else {
        // Agar foydalanuvchi boshqa chatda yoki boshqa tabda bo'lsa
        showToast(`Yangi xabar: ${data.sender}`, data.content);
    }

    // 3. MUHIM: Har doim chatlar ro'yxatini yangilash (loadList)
    // Bu xabar yuborgan odamni "Chatlar" bo'limida eng tepaga chiqaradi
    // Foydalanuvchi qaysi tabda bo'lishidan qat'i nazar, fon rejimida yangilanadi
    if (typeof loadList === "function") {
        // Biz faqat ma'lumotni yangilaymiz, tabni o'zgartirmaymiz
        refreshChatListSilently(); 
    }
});

// Fon rejimida ro'yxatni yangilash uchun yordamchi funksiya
async function refreshChatListSilently() {
    const chatList = document.getElementById('chatList');
    if (!chatList) return;

    try {
        const res = await fetch(`${API}/api/recent_chats?username=${currentUser}`);
        const contacts = await res.json();
        
        // Faqat "Chatlar" ro'yxati ichini qayta chizamiz
        // Bu foydalanuvchi ko'rib turgan tabga xalaqit bermaydi
        renderChatList(contacts); 
    } catch (e) {
        console.log("Ro'yxatni yangilashda xato:", e);
    }
}

// Chiroyli bildirishnoma ko'rsatish funksiyasi
function showToast(title, body) {
    // Brauzer bildirishnomasi
    if (Notification.permission === "granted") {
        new Notification(title, { 
            body: body, 
            icon: 'https://ui-avatars.com/api/?name=SafeChat&background=007aff&color=fff' 
        });
    } else if (Notification.permission !== "denied") {
        // Agar hali ruxsat so'ralmagan bo'lsa
        Notification.requestPermission();
    }
}

// Sahifa yuklanganda bildirishnomaga ruxsat so'rash
window.addEventListener('load', () => {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});

        let deferredPrompt;
const installBanner = document.getElementById('installBanner');

// 1. Dastlab banner yashirin bo'lishi kerak (CSS orqali ham yashirish mumkin)
installBanner.style.display = 'none';

window.addEventListener('beforeinstallprompt', (e) => {
    // Brauzerning standart oynasini to'xtatib turamiz
    e.preventDefault();
    deferredPrompt = e;
    // Endi biz o'zimizning bannerni ko'rsatsak bo'ladi
    installBanner.style.display = 'flex';
});

async function installApp() {
    if (!deferredPrompt) return;
    
    // O'rnatish oynasini ko'rsatish
    deferredPrompt.prompt();
    
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
        console.log('Foydalanuvchi ilovani o\'rnatdi');
    }
    
    // Banner bir marta ko'rsatilgach yashiriladi
    installBanner.style.display = 'none';
    deferredPrompt = null;
}

let replyToId = null;
let replyToText = "";
let replyToSender = "";
let selectedMessages = new Set();
let isSelectionMode = false;

// 1. Tanlash rejimini yoqish
function toggleSelectMode() {
    isSelectionMode = true;
    document.body.classList.add('selection-mode');
    document.getElementById('selectionBar').classList.remove('hidden');
    closeMenu();
}

// 2. Habarni tanlash/bekor qilish
function toggleMsgSelection(id) {
    if (!isSelectionMode) return;
    const el = document.getElementById(`container-${id}`);
    if (selectedMessages.has(id)) {
        selectedMessages.delete(id);
        el.classList.remove('selected');
    } else {
        selectedMessages.add(id);
        el.classList.add('selected');
    }
}

function showMenu(e, id, content, isMe) {
    const menu = document.getElementById('msgContextMenu');
    const msgElement = document.getElementById(`msg-${id}`);
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    if (!msgElement) return;

    // 1. XAVFSIZLIK: Faqat o'z xabari bo'lsa Tahrirlash va O'chirishni ko'rsatish
    // isMe argumenti appendMessage'dan keladi (data.sender === currentUser)
    if (isMe) {
        editBtn.style.display = "flex";
        deleteBtn.style.display = "flex";
    } else {
        editBtn.style.display = "none";
        deleteBtn.style.display = "none";
    }

    // 2. Koordinatalarni olish
    const rect = msgElement.getBoundingClientRect();
    menu.style.display = 'block';
    menu.classList.remove('hidden');

    // 3. POZITSIYA: Xabarning markaziga yaqinroq joylashtirish
    // Xabarning balandligi o'rtasidan biroz yuqoriroq
    let top = rect.top + (rect.height / 4); 
    let left;

    if (isMe) {
        // Mening xabarim (o'ngda): Menyu xabarning chap burchagiga yaqin chiqadi
        left = rect.left - (menu.offsetWidth / 2);
    } else {
        // Birovning xabari (chapda): Menyu xabarning o'ng burchagiga yaqin chiqadi
        left = rect.right - (menu.offsetWidth / 2);
    }

    // 4. EKRAN CHEGARALARI: Menyu ekrandan chiqib ketmasligi uchun
    const padding = 15; // Ekran chetidan masofa
    
    // Gorizontal tekshiruv
    if (left < padding) left = padding;
    if (left + menu.offsetWidth > window.innerWidth - padding) {
        left = window.innerWidth - menu.offsetWidth - padding;
    }

    // Vertikal tekshiruv
    if (top < padding) top = padding;
    if (top + menu.offsetHeight > window.innerHeight - padding) {
        top = window.innerHeight - menu.offsetHeight - padding;
    }

    menu.style.top = `${top}px`;
    menu.style.left = `${left}px`;

    // 5. MA'LUMOTLARNI SAQLASH
    selectedMsgId = id;
    selectedMsgText = content;
    
    // Fonni xiralashtirish (Telegram effektini beradi)
    const msgBox = document.getElementById('msgBox');
    msgBox.style.filter = "blur(2px)";
    msgBox.style.transition = "filter 0.2s";

    // Menyu ochilganda xabarni ajratib ko'rsatish (ixtiyoriy)
    msgElement.style.zIndex = "10001";
    msgElement.style.position = "relative";

    // Bir marta bosilganda menyuni yopish
    const autoClose = () => {
        closeMenu();
        document.removeEventListener('click', autoClose);
    };
    
// showMenu funksiyasi oxirida mana buni ishlating:
setTimeout(() => {
    // click hodisasi faqat bir marta ishlashi uchun {once: true} foydali
    document.addEventListener('click', closeMenu, { once: true });
}, 50);
}

// closeMenu funksiyasini ham moslashtiramiz
function closeMenu() {
    const menu = document.getElementById('msgContextMenu');
    const msgBox = document.getElementById('msgBox');
    
    // 1. Menyuni yashirish
    menu.style.display = 'none';
    menu.classList.add('hidden');
    
    msgBox.style.filter = "none"; 
    msgBox.classList.remove('blur-sm'); 
    
    document.removeEventListener('click', closeMenu);
}

function closeMenu() {
    const menu = document.getElementById('msgContextMenu');
    menu.style.display = 'none';
    document.getElementById('msgBox').classList.remove('blur-sm');
    document.removeEventListener('click', closeMenu);
}

// 3. Swipe to Reply (Surish orqali javob berish)
function initSwipe(element, msgId, text, sender) {
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;

    element.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        element.style.transition = "none"; 
    }, {passive: true});

    element.addEventListener('touchmove', e => {
        currentX = e.touches[0].clientX;
        let diff = currentX - startX; // ENDI: O'ngga surish uchun (current - start)

        if (diff > 0 && diff < 80) { // Faqat o'ngga 80px gacha surish
            isSwiping = true;
            element.style.transform = `translateX(${diff}px)`; // Musbat qiymat o'ngga suradi
            
            // Ixtiyoriy: Surish paytida reply belgisi (icon) ko'rinishi uchun
            // element.querySelector('.swipe-indicator').style.opacity = diff / 80;
        }
    }, {passive: true});

    element.addEventListener('touchend', () => {
        element.style.transition = "transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)"; 
        element.style.transform = `translateX(0)`; // Joyiga qaytarish

        // Agar 50px dan ko'proq o'ngga surilgan bo'lsa - Reply!
        if (isSwiping && (currentX - startX > 50)) {
            setupReply(msgId, text, sender);
        }
        isSwiping = false;
    });
}



// 1. Replyni o'rnatish
function setupReply(id, text, sender) {
    replyToId = id;
    replyToText = text;
    replyToSender = sender;

    const preview = document.getElementById('replyPreview');
    preview.innerHTML = `
        <div class="flex items-center p-2 gap-3">
            <div class="flex-1 min-w-0">
                <p class="text-[11px] font-bold text-blue-600">${sender}</p>
                <p class="text-xs text-gray-600 truncate opacity-80">${text}</p>
            </div>
            <i onclick="cancelReply()" class="fa-solid fa-xmark text-gray-400 p-2 cursor-pointer"></i>
        </div>
    `;
    preview.classList.remove('hidden');
    document.getElementById('msgInp').focus();
}

function cancelReply() {
    replyToId = null;
    document.getElementById('replyPreview').classList.add('hidden');
}

// 2. Selection (Tanlash) rejimi
function toggleSelectMode() {
    isSelectionMode = true;
    selectedMessages.clear();
    document.getElementById('msgBox').classList.add('selection-active');
    closeMenu();
}

function toggleMsgSelection(id) {
    if (!isSelectionMode) return;
    
    const container = document.getElementById(`container-${id}`);
    if (selectedMessages.has(id)) {
        selectedMessages.delete(id);
        container.classList.remove('selected-msg');
    } else {
        selectedMessages.add(id);
        container.classList.add('selected-msg');
    }

    // Panelni ko'rsatish yoki yashirish
    const bar = document.getElementById('selectionBar');
    if (selectedMessages.size > 0) {
        bar.classList.remove('hidden');
        bar.style.display = 'flex';
    } else {
        bar.classList.add('hidden');
        bar.style.display = 'none';
    }
}

function cancelSelection() {
    isSelectionMode = false;
    selectedMessages.clear();
    document.querySelectorAll('.msg-container').forEach(el => el.classList.remove('selected-msg'));
    document.getElementById('selectionBar').classList.add('hidden');
    document.getElementById('msgBox').classList.remove('selection-active');
}
function cancelReply() {
    replyToId = null;
    replyToText = "";
    replyToSender = "";
    document.getElementById('replyPreview').classList.add('hidden');
}
// 5. Forward (Boshqaga yuborish)
function handleForward() {
    const forwardText = selectedMsgText;
    const targetUser = prompt("Kimga yubormoqchisiz? (Username)");
    if(targetUser) {
    // To'g'ri misol:
        socket.emit('send_message', {
            sender: currentUser,
            receiver: activeChat,
            content: messageText,
            type: 'text'
        });
        alert("Yuborildi!");
    }
    closeMenu();
}
function bindContextEvents(element, data) {
    let pressTimer;
    const isMe = data.sender === currentUser;

    // --- DESKTOP: O'NG TUGMA ---
    element.oncontextmenu = function(e) {
        e.preventDefault();
        e.stopPropagation();
        showMenu(e, data.id, data.content, isMe);
        return false;
    };

    // 1. Qurilmani aniqlash
function updateDeviceInfo() {
    const ua = navigator.userAgent;
    let device = "Personal Computer";

    if (/Android/i.test(ua)) device = "Android Smartphone";
    if (/iPhone/i.test(ua)) device = "Apple iPhone";
    if (/iPad/i.test(ua)) device = "Apple iPad";
    if (/Windows/i.test(ua)) device = "Windows Kompyuter";
    if (/Macintosh/i.test(ua)) device = "MacOS Kompyuter";

    document.getElementById("currentDevice").innerText = device;

    // Saqlab qo'yish (ixtiyoriy)
    localStorage.setItem("device", device);
}

// 2. Dark Mode
function toggleDarkMode(checkbox) {
    if (checkbox.checked) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        document.body.style.backgroundColor = '#1c1c1e';
    } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        document.body.style.backgroundColor = '#f2f2f7';
    }
}

// Sahifa yuklanganda barcha sozlamalarni tiklash
window.addEventListener('DOMContentLoaded', () => {
    // 1. Dark mode holatini tekshirish
    const savedTheme = localStorage.getItem("theme");
    const darkSwitch = document.querySelector('input[onchange="toggleDarkMode(this)"]');
    
    if (savedTheme === "dark") {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark-mode');
        if (darkSwitch) darkSwitch.checked = true;
    }

    // 2. Profilni yuklash (agar login qilingan bo'lsa)
    if (localStorage.getItem('username')) {
        updateAllUI();
    }
});

// // 2. Tab almashtirishda Profilni yangilash
// const originalSwitchTab = switchTab; // Agar switchTab avval e'lon qilingan bo'lsa
// switchTab = function(tabName) {
//     // Eski switchTab funksiyasini chaqirish
//     document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
//     document.getElementById(tabName + 'Tab').classList.remove('hidden');
    
//     // Profil yoki Sozlamalar ochilganda UI ni yangilash
//     if(tabName === 'profile' || tabName === 'settings') {
//         updateProfileUI();
//         checkAdminAccess(); // Admin tugmasini tekshirish
//     }
    
//     // Navigatsiyani yangilash (Oldingi kodingizga moslash)
//     updateNavUI(tabName); 
// }

// 3. Admin Panelni ochish (Haqiqiy interfeys)
function showAdminPanel() {
    const panel = document.createElement('div');
    panel.id = "adminOverlay";
    panel.className = "fixed inset-0 bg-black z-[100] p-6 font-mono text-green-500 overflow-y-auto";
    panel.innerHTML = `
        <div class="flex justify-between items-center border-b border-green-900 pb-4 mb-6">
            <h2 class="text-xl font-bold tracking-tighter">SAFECHAT_CORE_ROOT</h2>
            <button onclick="document.getElementById('adminOverlay').remove()" class="bg-red-600 text-white px-3 py-1 rounded text-xs">EXIT</button>
        </div>
        <div class="space-y-4">
            <div class="bg-green-950/30 p-4 rounded border border-green-900">
                <p class="text-xs opacity-50 mb-2">SYSTEM_STATUS:</p>
                <div class="flex justify-between text-sm">
                    <span>Server: <b class="text-green-400">ONLINE</b></span>
                    <span>Users: <b class="text-green-400">1,240</b></span>
                </div>
            </div>
            <table class="w-full text-[10px] text-left">
                <thead class="bg-green-900 text-black">
                    <tr><th class="p-2">User</th><th class="p-2">IP</th><th class="p-2">Status</th></tr>
                </thead>
                <tbody id="adminUsersList">
                    <tr class="border-b border-green-900/30"><td class="p-2">@admin</td><td class="p-2">127.0.0.1</td><td class="p-2">Root</td></tr>
                    <tr class="border-b border-green-900/30"><td class="p-2">@jasur_dev</td><td class="p-2">94.158.1.1</td><td class="p-2 text-yellow-500">Active</td></tr>
                </tbody>
            </table>
        </div>
    `;
    document.body.appendChild(panel);
}

function loadTheme() {
    const savedTheme = localStorage.getItem("theme");

    if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
    }
}
loadTheme(); // birinchi chaqirilishi


// 3. Ma'lumotlarni o'zgartirish (Prompt orqali)
async function editValue(type) {
    let newVal = prompt(`Yangi ${type}ni kiriting:`);

    if (!newVal || newVal.trim() === "") {
        alert("Qiymat bo'sh boâ€˜la olmaydi!");
        return;
    }

    // Username boâ€˜lsa, domain qoâ€˜shamiz
    if (type === "username") {
        if (!newVal.includes(".connect.uz")) {
            newVal = newVal + ".connect.uz";
        }
    }

    // API endpoint
    const endpoint =
        type === "password"
            ? "/api/update_password"
            : "/api/update_user";

    // Yuboriladigan ma'lumot
    const body = {
        user: currentUser,
        field: type,
        value: newVal
    };

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert("Ma'lumotlar muvaffaqiyatli yangilandi!");

            // Username yangilanganda localStorage yangilaymiz
            if (type === "username") {
                localStorage.setItem("user", newVal);
            }

            // Logout qilish
            alert("Iltimos, tizimga qaytadan kiring.");
            logout();
        } else {
            alert("Xatolik yuz berdi, yana urinib koâ€˜ring.");
        }
    } catch (err) {
        console.error("Xato:", err);
        alert("Server bilan ulanishda muammo!");
    }
}

async function loadAdminStats() {
    const res = await fetch('/api/admin/stats');
    const data = await res.json();
    // Admin paneldagi HTML elementlarga qiymatlarni yozish
    document.getElementById('stat_total').innerText = data.total;
    document.getElementById('stat_online').innerText = data.online;
}

function submitApplication() {
    const data = {
        name: document.getElementById('app_name').value,
        phone: document.getElementById('app_phone').value,
        reason: document.getElementById('app_reason').value
    };
    fetch('/api/apply', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(() => {
        alert("Ariza yuborildi!");
        closeSheet('applySheet');
    });
}

// 4. Admin tugmasini tekshirish (Faqat sizning raqam uchun)
function checkAdminAccess() {
    const phone = localStorage.getItem('user_phone');
    if(phone === '958883851' || phone === '+998958883851') {
        document.getElementById('adminAccessBtn').classList.remove('hidden');
    }
}

// Sahifa yuklanganda barchasini ishga tushirish
window.addEventListener('load', () => {
    updateDeviceInfo();
    checkAdminAccess();
});
    // --- MOBILE: UZOQ BOSIB TURISH ---
    element.addEventListener('touchstart', function(e) {
        // Agar tanlash (select) rejimida bo'lsak, menyu chiqmasin
        if (isSelectionMode) return;

        pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50); // Vibratsiya
            
            // Sensor nuqtasini olish
            const touch = e.touches[0];
            showMenu(touch, data.id, data.content, isMe);
        }, 600); // 600ms - uzoq bosish vaqti
    }, { passive: true });

    element.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });

    element.addEventListener('touchmove', function() {
        clearTimeout(pressTimer); // Skrol qilinganda menyuni chiqarmaslik
    });
}

function saveStatus() {
    const val = prompt("Yangi status kiriting:", localStorage.getItem("userStatus") || "");
    if (val !== null) {
        localStorage.setItem("userStatus", val);
        loadStatus();
    }
}


// --- 3. DEVICE SESSIONS ---
function updateDeviceInfo() {
    const currentDevice = navigator.userAgent.split(')')[0].split('(')[1] || "Noma'lum qurilma";
    const sessions = [
        { device: currentDevice, time: "Hozir faol", ip: "94.158.xx.xx (Siz)" },
        { device: "Telegram Desktop / Windows", time: "2 soat oldin", ip: "178.218.xx.xx" },
        { device: "iPhone 15 Pro / Safari", time: "Kecha, 22:45", ip: "213.230.xx.xx" }
    ];
    // Bu ma'lumotlarni sheet ochilganda innerHTML qilib chiqarsangiz bo'ladi
    console.log("Sessions updated", sessions);
}

// --- 5. 2FA (TWO-STEP VERIFICATION) ---
function setup2FA() {
    const pass = prompt("Ikki bosqichli himoya parolini yarating:");
    if(pass && pass.length >= 4) {
        localStorage.setItem("twoFA", pass);
        document.getElementById('twoFAStatusLabel').innerText = "ON";
        document.getElementById('twoFAStatusLabel').className = "text-green-500 text-[10px] font-black bg-green-50 px-2 py-1 rounded-lg";
        alert("2FA faollashtirildi!");
    }
}

// --- BARCHA UI ELEMENTLARINI YANGILASH (PROFIL VA SOZLAMALAR) ---
function updateAllUI() {
    // 1. Ma'lumotlarni localStorage'dan yig'ib olish
    const user = {
        name: localStorage.getItem('username') || 'Foydalanuvchi',
        phone: localStorage.getItem('user_phone') || '+998 00 000 00 00',
        bio: localStorage.getItem('user_bio') || 'Bio ma\'lumot kiritilmagan',
        status: localStorage.getItem('userStatus') || 'Status o\'rnatish...',
        username: (localStorage.getItem('username') || 'user').toLowerCase().replace(/\s/g, ''),
        twoFA: localStorage.getItem('twoFA'),
        theme: localStorage.getItem('theme') || 'light',
        hiddenPin: localStorage.getItem('hiddenPin')
    };

    // 2. Yordamchi funksiya: Elementni xavfsiz yangilash
    const safeUpdate = (id, value, type = 'innerText') => {
        const el = document.getElementById(id);
        if (el) el[type] = value;
    };

    // 3. Matnli ma'lumotlarni joylashtirish
    safeUpdate('profileName', user.name);
    safeUpdate('settingsName', user.name);
    safeUpdate('profileUsername', '@' + user.username);
    safeUpdate('settingsUsername', '@' + user.username);
    safeUpdate('profileStatusDisplay', user.status);
    safeUpdate('settingsBio', user.bio);
    safeUpdate('profilePhone', user.phone);

    // 4. Avatar (Profil rasmi) boshqaruvi
    const savedAvatar = localStorage.getItem('userAvatarBase64');
    const defaultAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=007aff&color=fff`;
    const finalAvatar = savedAvatar || defaultAvatar;

    safeUpdate('profileAvatar', finalAvatar, 'src');
    safeUpdate('userAvatar', finalAvatar, 'src'); // Navbardagi kichik rasm

    // 5. 2-Step Verification (2FA) Statusi
    const twoFALabel = document.getElementById('twoFAStatusLabel');
    if (twoFALabel) {
        if (user.twoFA) {
            twoFALabel.innerText = "ON";
            twoFALabel.className = "text-green-500 text-[10px] font-black bg-green-50 px-2 py-1 rounded-lg border border-green-100";
        } else {
            twoFALabel.innerText = "OFF";
            twoFALabel.className = "text-red-500 text-[10px] font-black bg-red-50 px-2 py-1 rounded-lg border border-red-100";
        }
    }

    // 6. Yashirin Chatlar (PIN) Ikonkasi
    const lockIcon = document.getElementById('lockStatusIcon');
    if (lockIcon) {
        if (user.hiddenPin) {
            lockIcon.classList.replace('text-gray-300', 'text-purple-600');
        } else {
            lockIcon.classList.replace('text-purple-600', 'text-gray-300');
        }
    }

    // 7. Dark Mode Holatini tiklash
    const themeToggle = document.querySelector('input[onchange="toggleDarkMode(this)"]');
    if (user.theme === 'dark') {
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark-mode');
        if (themeToggle) themeToggle.checked = true;
    } else {
        document.documentElement.classList.remove('dark');
        document.body.classList.remove('dark-mode');
        if (themeToggle) themeToggle.checked = false;
    }
    const savedTheme = localStorage.getItem('theme');

    if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        if (themeToggle) themeToggle.checked = true;
        document.body.style.backgroundColor = '#1c1c1e';
    }
    // 8. Faol seanslar sonini ko'rsatish
    const deviceBadge = document.querySelector('#profileTab span.bg-green-100');
    if (deviceBadge) {
        // Haqiqiy mantiqda bu yerda session list uzunligi olinadi
        deviceBadge.innerText = "1 active"; 
    }

    console.log("ðŸš€ Barcha interfeys elementlari yangilandi!");
}

// --- 2. YASHIRIN CHATLAR (PIN LOCK) ---
function unlockHiddenChats() {
    const savedPin = localStorage.getItem("hiddenPin");
    if (!savedPin) {
        alert("Avval Sozlamalar bo'limida PIN-kod o'rnating!");
        switchTab('settings');
        return;
    }
    const entered = prompt("Yashirin chatlar uchun PIN kiriting:");
    if (entered === savedPin) {
        alert("Xush kelibsiz! Yashirin chatlar ro'yxati ochilmoqda...");
        // Bu yerda chatList filtrlanadi
    } else {
        alert("PIN noto'g'ri!");
    }
}


// --- 5. RASMNI ALMASHTIRISH (AVATAR) ---
function triggerAvatarUpload() {
    document.getElementById('avatarInput').click();
}

function handleAvatarSelection(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('userAvatarBase64', e.target.result);
            updateAllUI();
        };
        reader.readAsDataURL(file);
    }
}

 
// --- 1. STATUS FUNKSIYASI ---
function openStatusSheet() {
    const currentStatus = localStorage.getItem("userStatus") || "";
    const newStatus = prompt("Yangi status kiriting (masalan: Band, O'qishda):", currentStatus);
    
    if (newStatus !== null) {
        localStorage.setItem("userStatus", newStatus.trim());
        updateAllUI(); // Profil sahifasidagi matnni yangilaydi
    }
}

// --- 2. PROFILNI ULASHISH (SHARE/COPY ID) ---
function copyMyID() {
    const username = localStorage.getItem('username') || "User";
    const profileLink = `https://safechat.uz/user/${username.toLowerCase()}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'SafeChat Profili',
            text: `${username} bilan SafeChat'da bog'laning!`,
            url: profileLink,
        }).catch(console.error);
    } else {
        // Share ishlamasa, clipboard'ga nusxalash
        navigator.clipboard.writeText(profileLink).then(() => {
            alert("Profil havolasi nusxalandi: " + profileLink);
        });
    }
}

// --- 3. IKKI BOSQICHLI TEKSHIRUV (2FA) ---
function openTwoFASheet() {
    const isEnabled = localStorage.getItem("twoFA");
    
    if (isEnabled) {
        const confirmDisable = confirm("Ikki bosqichli tekshiruv yoqilgan. Uni o'chirmoqchimisiz?");
        if (confirmDisable) {
            const pass = prompt("O'chirish uchun joriy 2FA parolini kiriting:");
            if (pass === isEnabled) {
                localStorage.removeItem("twoFA");
                alert("Xavfsizlik o'chirildi.");
            } else {
                alert("Parol noto'g'ri!");
            }
        }
    } else {
        const newPass = prompt("Yangi 2FA parolini o'rnating (kamida 4 ta belgi yoki raqam):");
        if (newPass && newPass.trim().length >= 4) {
            localStorage.setItem("twoFA", newPass.trim());
            alert("ðŸ”’ Ikki bosqichli himoya faollashtirildi!");
        } else if (newPass !== null) {
            alert("Xato: Parol kamida 4 ta belgidan iborat bo'lishi kerak!");
        }
    }
    updateAllUI(); // ON/OFF belgisini yangilash uchun
}

// --- 4. FAOL SEANSLAR (DEVICES) ---
function openDeviceSheet() {
    const platform = navigator.platform;
    const browser = navigator.userAgent.includes("Chrome") ? "Chrome" : "Safari";
    const now = new Date().toLocaleTimeString();
    
    // Kelajakda bu yerda haqiqiy Sheet ochilishi kerak, hozircha alert:
    alert(`ðŸ“± Joriy seans:\nQurilma: ${platform}\nBrauzer: ${browser}\nIP: 94.158.52.xx\nStatus: Faol (Hozir)\n\nBarcha boshqa seanslar yakunlandi.`);
}

// --- 5. SAQLANGAN XABARLAR ---
function openSavedMessages() {
    // Chat bo'limiga yo'naltirish yoki maxsus chatni ochish
    alert("Saqlangan xabarlar bo'limi yuklanmoqda...");
    // switchTab('chats'); // Misol uchun chatlar bo'limiga o'tkazish
}

// --- 6. FIELDLARNI TAHRIRLASH (Name, Bio, Username) ---
function editField(fieldName) {
    const keys = { 'Name': 'username', 'Username': 'username', 'Bio': 'user_bio' };
    const key = keys[fieldName];
    const currentVal = localStorage.getItem(key) || "";
    
    let newVal = prompt(`${fieldName}ni kiriting:`, currentVal);
    if (newVal !== null) {
        localStorage.setItem(key, newVal);
        updateAllUI();
    }
}

// --- 7. LOAD STATUS (Tab o'zgarganda chaqiriladi) ---
function loadStatus() {
    const status = localStorage.getItem("userStatus") || "Status o'rnatish...";
    const el = document.getElementById("profileStatusDisplay");
    if (el) el.innerText = status;
}
// Global o'zgaruvchi: Hozirgi ko'rilayotgan foydalanuvchi ma'lumotlarini saqlash uchun
let currentViewedUser = null;

// --- 1. PROFILNI OCHISH (Socket/Data bilan) ---
function openUserMenu(userData = null) {
    // Agar data kelmasa, chat headerdan ma'lumotlarni yig'ish
    if (!userData) {
        currentViewedUser = {
            id: document.getElementById('activeChatImg').getAttribute('data-user-id'),
            name: document.getElementById('activeName').innerText,
            img: document.getElementById('activeChatImg').src,
            phone: "+998 90 123 45 67", // Bularni bazadan chaqirish kerak
            username: "@" + document.getElementById('activeName').innerText.toLowerCase().replace(/\s/g, ''),
            bio: "SafeChat Connection Connection a'zosi",
            status: "online"
        };
    } else {
        currentViewedUser = userData;
    }

    renderProfileUI(currentViewedUser);

    document.getElementById('fullUserProfile').classList.remove('hidden');
    document.getElementById('fullUserProfile').classList.add('flex');
    
    loadSharedMedia();
}

// UI-ni yangilash funksiyasi
function renderProfileUI(user) {
    document.getElementById('fullProfileName').innerText = user.name;
    document.getElementById('fullProfileImg').src = user.img;
    document.getElementById('bgBlurImg').src = user.img;
    document.getElementById('fullProfileStatus').innerText = user.status;
    document.getElementById('fullProfilePhone').innerText = user.phone;
    document.getElementById('fullProfileUsername').innerText = user.username;
    document.getElementById('fullProfileBio').innerText = user.bio;
}

// --- 2. SOCKET.IO REAL-TIME YANGILASH ---
// Serverdan socket.on('user_update') kelsa
if (typeof socket !== 'undefined') {
    socket.on('user_update', (data) => {
        if (currentViewedUser && currentViewedUser.id === data.userId) {
            currentViewedUser = { ...currentViewedUser, ...data.fields };
            renderProfileUI(currentViewedUser);
        }
    });
}

// --- 3. TELEFON AMALLARI ---
function openPhoneActions() {
    const phone = document.getElementById('fullProfilePhone').innerText;
    document.getElementById('actionSheetNumber').innerText = phone;
    document.getElementById('callBtn').href = "tel:" + phone;
    
    document.getElementById('phoneActionOverlay').classList.add('active');
    document.getElementById('phoneActionSheet').classList.add('active');
}

function closePhoneMenu() {
    document.getElementById('phoneActionOverlay').classList.remove('active');
    document.getElementById('phoneActionSheet').classList.remove('active');
}


// --- 4. RASM VA MEDIA ---
function expandImage() {
    const src = document.getElementById('fullProfileImg').src;
    if (src.includes('ui-avatars')) return; // Rasm bo'lmasa ochmaydi

    document.getElementById('expandedImg').src = src;
    document.getElementById('viewerName').innerText = currentViewedUser.name;
    document.getElementById('photoViewer').classList.remove('hidden');
    document.getElementById('photoViewer').classList.add('flex');
}

function closePhotoViewer() { document.getElementById('photoViewer').classList.add('hidden'); }
function closeFullProfile() { document.getElementById('fullUserProfile').classList.add('hidden'); }

async function downloadProfileImg() {
    const link = document.createElement('a');
    link.href = document.getElementById('fullProfileImg').src;
    link.download = 'profile.jpg';
    link.click();
}

function loadSharedMedia() {
    const container = document.getElementById('sharedMediaContent');
    container.innerHTML = '';
    const images = document.querySelectorAll('#msgBox img');
    images.forEach(img => {
        const div = document.createElement('div');
        div.className = "aspect-square rounded-xl overflow-hidden bg-gray-100";
        div.innerHTML = `<img src="${img.src}" class="w-full h-full object-cover">`;
        container.appendChild(div);
    });
}
/**
 * 2. UI-NI YANGILASH (Real-time uchun alohida funksiya)
 */
function renderProfileData(user) {
    if (!user) return;
    
    document.getElementById('fullProfileName').innerText = user.name;
    document.getElementById('fullProfileImg').src = user.img;
    document.getElementById('bgBlurImg').src = user.img;
    document.getElementById('fullProfileStatus').innerText = user.status || "online";
    document.getElementById('fullProfilePhone').innerText = user.phone || "Mavjud emas";
    document.getElementById('fullProfileUsername').innerText = user.username || "@user";
    document.getElementById('fullProfileBio').innerText = user.bio || "Bio kiritilmagan";
}

/**
 * 3. SOCKET.IO ORQALI REAL-TIME YANGILANISHNI ESHITISH
 */
socket.on('user_update', (data) => {
    // data = { userId: "123", updatedFields: { name: "Yangi Ism", img: "yangi_url", ... } }
    
    // Agar hozirda shu foydalanuvchining profili ochiq bo'lsa
    if (currentViewedUser && currentViewedUser.id === data.userId) {
        currentViewedUser = { ...currentViewedUser, ...data.updatedFields };
        renderProfileData(currentViewedUser); // Profil oynasini yangilash
    }

    // Chat headerini ham yangilash
    const headerImg = document.getElementById('activeChatImg');
    if (headerImg && headerImg.getAttribute('data-user-id') === data.userId) {
        if (data.updatedFields.name) document.getElementById('activeName').innerText = data.updatedFields.name;
        if (data.updatedFields.img) headerImg.src = data.updatedFields.img;
    }
});


// Rasmni yuklab olish
async function downloadProfileImg() {
    const url = document.getElementById('fullProfileImg').src;
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `SafeChat_${currentViewedUser.name}.jpg`;
        a.click();
        URL.revokeObjectURL(blobUrl);
    } catch (err) {
        alert("Rasmni yuklab bo'lmadi.");
    }
}

// --- 1. TELEFON MENYUSINI OCHISH ---
function copyInfo(type) {
    if (type === 'phone') {
        const phone = document.getElementById('fullProfilePhone').innerText;
        document.getElementById('actionSheetNumber').innerText = phone;
        document.getElementById('callBtn').href = "tel:" + phone; // Haqiqiy qo'ng'iroq uchun
        
        // Menyuni ko'rsatish
        document.getElementById('phoneActionOverlay').classList.add('active');
        document.getElementById('phoneActionSheet').classList.add('active');
    } else {
        // Username uchun oddiy nusxalash
        const username = document.getElementById('fullProfileUsername').innerText;
        navigator.clipboard.writeText(username).then(() => alert("Username nusxalandi!"));
    }
}


// --- 3. MENYUNI YOPISH ---
function closePhoneMenu() {
    document.getElementById('phoneActionOverlay').classList.remove('active');
    document.getElementById('phoneActionSheet').classList.remove('active');
}

// Ulashish (Share)
function shareUserProfile() {
    if (navigator.share) {
        navigator.share({
            title: currentViewedUser.name,
            text: `SafeChat'da ${currentViewedUser.name} bilan bog'laning`,
            url: window.location.href
        });
    }
}

// Profilni va Photo Viewerni yopish
function closeFullProfile() { document.getElementById('fullUserProfile').classList.add('hidden'); }
function closePhotoViewer() { document.getElementById('photoViewer').classList.add('hidden'); }

function loadSharedMedia(userId) {
    const container = document.getElementById('sharedMediaContent');
    container.innerHTML = ''; // Tozalash

    // Bu yerda chatBox (msgBox) ichidagi barcha rasmlarni qidiramiz
    const allMessages = document.querySelectorAll('#msgBox img');
    let count = 0;

    allMessages.forEach(img => {
        count++;
        const div = document.createElement('div');
        div.className = "aspect-square rounded-xl overflow-hidden bg-gray-100 cursor-pointer active:scale-95 transition";
        div.innerHTML = `<img src="${img.src}" class="w-full h-full object-cover" onclick="openFullImage('${img.src}')">`;
        container.appendChild(div);
    });

    if (count === 0) {
        container.innerHTML = `<p class="col-span-3 text-center text-gray-400 text-[10px] py-10">Media mavjud emas</p>`;
    }
}

function switchMediaTab(type, btn) {
    // Tab rangini o'zgartirish
    document.querySelectorAll('.active-tab').forEach(el => {
        el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'active-tab');
        el.classList.add('text-gray-400');
    });
    btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'active-tab');
    
    // Kontentni filterlash (Bu yerda fayl yoki linklarni yuklash mantiqi bo'ladi)
    loadSharedMedia(currentViewedUser.id);
}
///
// OPEN / CLOSE FULL PROFILE
  function closeFullProfile() { document.getElementById('fullUserProfile').classList.add('hidden'); }
  
  // PHOTO VIEWER
  function expandImage() { document.getElementById('photoViewer').classList.remove('hidden'); }
  function closePhotoViewer() { document.getElementById('photoViewer').classList.add('hidden'); }

  // PHONE ACTION SHEET
  function openPhoneActions() {
    document.getElementById('phoneActionOverlay').classList.remove('hidden');
    document.getElementById('phoneActionSheet').classList.add('active');
  }
  function closePhoneMenu() {
    document.getElementById('phoneActionOverlay').classList.add('hidden');
    document.getElementById('phoneActionSheet').classList.remove('active');
  }

  // COPY PHONE / INFO
  function copyPhoneNumber() { navigator.clipboard.writeText(document.getElementById('fullProfilePhone').textContent); alert("Raqam nusxalandi!"); }
  function copyInfo(type) {
    let val = type === 'username' ? document.getElementById('fullProfileUsername').textContent : '';
    navigator.clipboard.writeText(val); alert(type + " nusxalandi!");
  }

  // MEDIA TABS
  function switchMediaTab(tab, el) {
    const buttons = el.parentElement.querySelectorAll('button');
    buttons.forEach(b => b.classList.remove('text-blue-600', 'border-b-2'));
    el.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'active-tab');
    // TODO: load media/files/links based on tab
    console.log("Active Tab:", tab);
  }

// Agar ilova allaqachon o'rnatilgan bo'lsa, bannerni ko'rsatmaslik
window.addEventListener('appinstalled', () => {
    installBanner.style.display = 'none';
    deferredPrompt = null;
});

         </script>
</body>
</html>