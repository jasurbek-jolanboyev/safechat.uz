<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SafeChat Connection | Secure Messaging</title>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    
<style>

    #navIndicator {
    position: absolute;
    bottom: 8px; /* Pastdan masofa */
    height: 52px;
    background: rgba(0, 122, 255, 0.1);
    border-radius: 28px;
    transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1); /* iOS uslubidagi silliq harakat */
    z-index: 0;
    }
    /* 1. O'ZGARUVCHILAR VA ASOSIY SOZLAMALAR */
    :root {
        --ios-bg: #f2f2f7;
        --ios-accent: #007aff;
        --glass: rgba(255, 255, 255, 0.85);
        --radius-xl: 32px;
        --vh: 1vh;
    }

    * { 
        -webkit-tap-highlight-color: transparent; 
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
        box-sizing: border-box;
    }

    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Skrol faqat ichki elementlarda bo'ladi */
        background-color: var(--ios-bg);
    }

    #mainApp {
        height: calc(var(--vh, 1vh) * 100);
        display: flex;
        flex-direction: column;
    }

    /* 2. TABLAR VA KARTALAR (PROFIL/SOZLAMALAR) */
    .tab-content {
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: var(--ios-bg);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        animation: iosFade 0.3s ease-out;
    }

    @keyframes iosFade {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .profile-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        color: #000;
    }

    /* 3. CHAT AREA VA XABARLAR */
    #chatArea {
        position: fixed;
        inset: 0;
        background: #F2F2F7;
        z-index: 5000; 
        display: none;
        flex-direction: column;
        width: 100%;
        height: 100%;
    }

    #msgBox {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background: #e5ddd5; /* WhatsApp uslubidagi fon */
        display: flex;
        flex-direction: column;
        -webkit-overflow-scrolling: touch;
    }

    .bubble { 
        max-width: 75%; 
        padding: 10px 14px; 
        border-radius: 18px; 
        font-size: 16px; 
        margin-bottom: 8px; 
        line-height: 1.4; 
        word-wrap: break-word; 
        position: relative;
        cursor: pointer;
        transition: transform 0.1s;
    }

    .bubble.sent { 
        background: var(--ios-accent); 
        color: white; 
        align-self: flex-end; 
        border-bottom-right-radius: 4px; 
    }

    .bubble.received { 
        background: white; 
        color: black; 
        align-self: flex-start; 
        border-bottom-left-radius: 4px; 
    }

    .bubble:active { transform: scale(0.97); }

    /* 4. IOS SHEETS (PASTKI PANELLAR) */
    .ios-sheet {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background: white;
        z-index: 6000; 
        transition: bottom 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        border-radius: 24px 24px 0 0;
        padding-bottom: env(safe-area-inset-bottom, 20px);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        max-height: 90%;
        overflow-y: auto;
    }

    .ios-sheet.active { bottom: 0; }

    .sheet-handle { 
        width: 36px; height: 5px; background: #c7c7cc; 
        border-radius: 3px; margin: 12px auto; 
    }

    .sheet-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
        z-index: 5500; display: none; backdrop-filter: blur(2px); 
    }

    .sheet-overlay.active { display: block; }

    /* 5. NAVIGATSIYA */
    .bottom-nav { 
        position: fixed; bottom: 0; left: 0; right: 0; 
        height: 85px; background: var(--glass); 
        backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); 
        display: flex; justify-content: space-around; 
        padding-top: 10px; z-index: 100; 
    }

    .nav-item { 
        display: flex; flex-direction: column; align-items: center; 
        color: #8e8e93; font-size: 11px; flex: 1; transition: 0.2s; 
    }

    .nav-item.active { color: var(--ios-accent); }
    .nav-item i { font-size: 24px; margin-bottom: 4px; }

    /* 6. QO'SHIMCHA ELEMENTLAR */
    .media-content { border-radius: 12px; margin-top: 5px; max-width: 100%; display: block; }
    
    #adminPanel { 
        display: none; background: #1c1c1e; color: #32d74b; 
        position: fixed; inset: 0; z-index: 9999; padding: 20px; 
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body>

    <div id="installBanner" class="install-banner glass-panel p-4 rounded-3xl shadow-2xl flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white"><i class="fa-solid fa-download"></i></div>
            <div><p class="text-sm font-bold">SafeChat App</p><p class="text-xs text-gray-500">Ilovani o'rnatishni tavsiya qilamiz</p></div>
        </div>
        <button onclick="installApp()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold">O'rnatish</button>
    </div>

<div id="countryModal" class="hidden fixed inset-0 z-[7000] bg-white flex flex-col animate-slide-up">
    <div class="p-4 flex items-center gap-4 border-b">
        <i class="fa-solid fa-arrow-left text-xl cursor-pointer" onclick="closeCountryModal()"></i>
        <input type="text" id="countrySearch" oninput="filterCountries()" placeholder="Davlatni qidirish..." class="flex-1 p-2 outline-none text-lg">
    </div>
    <div id="countryList" class="flex-1 overflow-y-auto">
        </div>
</div>

<div id="authScreen" class="fixed inset-0 z-[5000] flex items-center justify-center p-6 bg-[#f2f2f7]">
    <div class="glass-panel w-full max-w-[420px] p-8 rounded-[40px] shadow-2xl bg-white/80 backdrop-blur-xl">
        <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-6 flex items-center justify-center text-white text-4xl shadow-lg">
            <i class="fa-solid fa-shield-halved"></i>
        </div>
        
        <div id="loginView">
            <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">Kirish</h1>
            <p class="text-gray-500 text-center mb-8">SafeChat Tizimiga qaytish</p>
            <div class="space-y-4">
                <div class="relative">
                    <input type="text" id="login_u" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="username">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">.connect.uz</span>
                </div>
                <input type="password" id="login_p" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="Parol">
                <button onclick="login()" class="w-full py-4 bg-blue-600 text-white rounded-[20px] text-lg font-semibold shadow-xl active:scale-95 transition">Tizimga kirish</button>
                <p class="text-center text-sm text-gray-500 mt-4">Hisobingiz yo'qmi? <span onclick="toggleAuth(true)" class="text-blue-600 font-bold cursor-pointer">Ro'yxatdan o'tish</span></p>
            </div>
        </div>

        <div id="registerView" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-2">Ro'yxatdan o'tish</h1>
            <p class="text-gray-500 text-center mb-6 text-sm">Xalqaro xavfsiz hisob yarating</p>
            
            <div class="space-y-3">
                <div onclick="openCountryModal()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl flex items-center justify-between cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span id="selectedFlag" class="text-2xl">ðŸ‡ºðŸ‡¿</span>
                        <span id="selectedCountryName" class="font-medium">Uzbekistan</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-400"></i>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="phoneCode" class="w-20 p-4 bg-gray-50 border border-gray-100 rounded-2xl text-center font-bold" value="+998" readonly>
                    <input type="tel" id="reg_phone" class="flex-1 p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="901234567">
                </div>

                <div class="relative">
                    <input type="text" id="reg_u" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="username">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">.connect.uz</span>
                </div>
                
                <input type="password" id="reg_p" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none" placeholder="Parol">
                <button onclick="register()" class="w-full py-4 bg-green-600 text-white rounded-[20px] text-lg font-semibold shadow-xl">Hisobni yaratish</button>
                <p class="text-center text-sm text-gray-500 mt-4">Hisobingiz bormi? <span onclick="toggleAuth(false)" class="text-blue-600 font-bold cursor-pointer">Kirish</span></p>
            </div>
        </div>
        
        <p onclick="showAdminLogin()" class="text-center text-[10px] text-gray-400 mt-8 uppercase tracking-widest cursor-pointer hover:text-blue-500">CEO & ADMIN ACCESS ONLY</p>
    </div>
</div>

    <div id="mainApp" class="hidden h-full flex flex-col md:flex-row overflow-hidden">
        
    <aside class="w-full md:w-[380px] flex-shrink-0 border-r border-gray-100 flex flex-col bg-[#f2f2f7] relative h-screen overflow-y-auto z-40">
        
            <header class="p-4 bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="tabTitle" class="text-2xl font-black text-gray-900">Chatlar</h2>
                    <!-- Plus tugmasi olib tashlandi -->
                    <button id="toggleSearch" class="text-gray-500 text-xl cursor-pointer">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
                <!-- Qidiruv oynasi dastlab yashirilgan -->
                <div id="searchWrapper" class="relative hidden transition-all duration-300">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="userSearch" oninput="liveSearch(this.value)"
                        class="w-full p-2.5 pl-11 bg-gray-100 rounded-xl outline-none focus:bg-white transition-all text-sm"
                        placeholder="Qidiruv...">
                </div>
            </header>


            <div class="flex-1 overflow-y-auto no-scrollbar pb-28">
                <div id="chatsTab" class="tab-content p-4 space-y-2">
                    <div id="chatList" class="space-y-1"></div>
                </div>
                <div id="groupsTab" class="tab-content hidden p-4 space-y-2">
    <div id="groupList" class="space-y-1"></div>
</div>

<div class="fixed bottom-5 left-0 right-0 px-5 pb-[env(safe-area-inset-bottom,24px)] pt-6 z-50 bg-gradient-to-t from-gray-50/80 to-transparent pointer-events-none">
    <nav class="pointer-events-auto bg-white/70 backdrop-blur-[25px] border border-white/40 rounded-[38px] shadow-[0_12px_40px_rgba(0,0,0,0.08)] p-2 flex justify-around items-center relative overflow-hidden ring-1 ring-black/[0.03]">
        
        <div id="navIndicator" class="absolute h-[52px] bg-[#007aff]/10 rounded-[28px] transition-all duration-500 ease-[cubic-bezier(0.2,1,0.3,1)] z-0"></div>

        <button id="nav-chats" onclick="switchTab('chats')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-[#007aff] transition-all duration-300 active:scale-90">
            <i class="fa-solid fa-comment-dots text-[22px]"></i>
            <span class="text-[10px] mt-1 font-semibold tracking-tight">Chatlar</span>
        </button>

        <button id="nav-groups" onclick="switchTab('groups')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
            <i class="fa-solid fa-globe text-[22px]"></i>
            <span class="text-[10px] mt-1 font-semibold tracking-tight">Ommaviy</span>
        </button>

        <div class="flex items-center justify-center px-2">
            <button onclick="openSheet('createEntitySheet')" class="flex items-center justify-center w-[54px] h-[54px] bg-[#007aff] rounded-full shadow-[0_8px_20px_rgba(0,122,255,0.3)] z-20 active:scale-[0.85] transition-all duration-300 hover:brightness-110">
                <i class="fa-solid fa-plus text-white text-2xl"></i>
            </button>
        </div>

        <button id="nav-settings" onclick="switchTab('settings')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
            <i class="fa-solid fa-gears text-[22px]"></i>
            <span class="text-[10px] mt-1 font-semibold tracking-tight">Sozlamalar</span>
        </button>
        
        <button id="nav-profile" onclick="switchTab('profile')" class="nav-item flex flex-col items-center justify-center flex-1 h-12 z-10 text-gray-400 transition-all duration-300 active:scale-90">
            <i class="fa-solid fa-circle-user text-[22px]"></i>
            <span class="text-[10px] mt-1 font-semibold tracking-tight">Profil</span>
        </button>

 

    </nav>
</div>

    </aside>

        <main id="chatArea" class="flex flex-1 flex-col bg-white relative md:flex">
            <header class="p-4 pt-14 flex justify-between items-center border-b glass-panel sticky top-0 z-20">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-blue-600 mr-2" onclick="closeChatArea()"><i class="fa-solid fa-chevron-left text-xl"></i></button>
                    <img id="activeChatImg" src="" class="w-11 h-11 rounded-full object-cover">
                    <div onclick="openUserMenu()">
                        <h4 id="activeName" class="font-bold text-[17px]">Suhbatdosh</h4>
                        <p class="text-xs text-blue-500">online</p>
                    </div>
                </div>
                <div class="flex gap-5 text-blue-600 text-xl">
                    <i class="fa-solid fa-phone cursor-pointer" onclick="initiateCall('audio')"></i>
                    <i class="fa-solid fa-video cursor-pointer" onclick="initiateCall('video')"></i>
                    <i class="fa-solid fa-circle-info cursor-pointer" onclick="openSheet('ceoSheet')"></i>
                </div>
            </header>

            <div id="msgBox" class="flex-1 overflow-y-auto p-6 flex flex-col no-scrollbar bg-[#f2f2f7]"></div>

            <footer id="chatFooter" class="p-4 pb-10 flex items-center gap-3 glass-panel">
                <i class="fa-solid fa-plus text-blue-600 text-2xl cursor-pointer" onclick="openSheet('mediaSheet')"></i>
                <input type="text" id="msgInp" onkeypress="handleEnter(event)" placeholder="Xabar yozing..." class="flex-1 p-3 bg-gray-100 rounded-[24px] outline-none border-0 focus:ring-2 focus:ring-blue-100 transition">
                <button onclick="sendMsg()" id="sendBtn" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition">
                    <i id="sendBtnIcon" class="fa-solid fa-arrow-up"></i>
                </button>
            </footer>
        </main>
    </div>

        <div id="msgContextMenu" class="context-menu hidden">
            <button onclick="handleReply()"><i class="fa-solid fa-reply text-blue-500"></i> Javob berish</button>
            <button onclick="copyMsg()"><i class="fa-solid fa-copy text-gray-500"></i> Nusxalash</button>
            
            <button id="editBtn" onclick="startEditMsg()"><i class="fa-solid fa-pen text-amber-500"></i> Tahrirlash</button>
            
            <button onclick="handleForward()"><i class="fa-solid fa-share text-green-500"></i> Uzatish</button>
            <button onclick="handlePin()"><i class="fa-solid fa-thumbtack text-purple-500"></i> Qadash (Pin)</button>
            <button onclick="toggleSelectMode()"><i class="fa-solid fa-check-double text-blue-400"></i> Tanlash</button>
            
            <button id="deleteBtn" onclick="deleteMsgServer()" class="text-red-500 border-t mt-1 pt-1">
                <i class="fa-solid fa-trash"></i> O'chirish
            </button>
        </div>

        <div id="replyPreview" class="hidden border-l-4 border-blue-500 mx-2 my-1 rounded-r-lg bg-white/20 backdrop-blur-md">
    </div>

        <div id="selectionBar" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-lg rounded-2xl shadow-2xl px-6 py-3 flex gap-8 z-[50] border border-gray-200">
            <button onclick="bulkCopy()" class="flex flex-col items-center text-blue-600">
                <i class="fa-solid fa-copy"></i><span class="text-[10px] mt-1">Copy</span>
            </button>
            <button onclick="bulkForward()" class="flex flex-col items-center text-green-600">
                <i class="fa-solid fa-share"></i><span class="text-[10px] mt-1">Forward</span>
            </button>
            <button onclick="bulkDelete()" class="flex flex-col items-center text-red-600">
                <i class="fa-solid fa-trash"></i><span class="text-[10px] mt-1">Delete</span>
            </button>
            <button onclick="cancelSelection()" class="flex flex-col items-center text-gray-500">
                <i class="fa-solid fa-xmark"></i><span class="text-[10px] mt-1">Exit</span>
            </button>
        </div>

    <div id="createEntitySheet" class="ios-sheet h-[60%]">
        <div class="sheet-handle"></div>
        <div class="p-8">
            <h2 class="text-3xl font-black mb-6 text-gray-800">Yangi yaratish</h2>
            <div class="flex bg-gray-200 p-1 rounded-2xl mb-6">
                <button id="btnTypeGroup" onclick="setEntityType('group')" class="flex-1 py-3 rounded-xl bg-white shadow-sm font-bold text-gray-800">Guruh</button>
                <button id="btnTypeChannel" onclick="setEntityType('channel')" class="flex-1 py-3 rounded-xl font-bold text-gray-500">Kanal</button>
            </div>
            <input type="text" id="entityName" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none mb-4" placeholder="Nomi">
            <button onclick="createEntity()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">Tasdiqlash</button>
        </div>
    </div>

    <div id="mediaSheet" class="ios-sheet h-[45%]">
        <div class="sheet-handle"></div>
        <div class="p-8 grid grid-cols-4 gap-6 text-center">
            <div onclick="triggerUpload('image')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-image"></i></div>
                <span class="text-xs font-bold text-gray-600">Foto</span>
            </div>
            <div onclick="triggerUpload('video')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-video"></i></div>
                <span class="text-xs font-bold text-gray-600">Video</span>
            </div>
            <div onclick="triggerUpload('file')" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-orange-100 text-orange-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-file"></i></div>
                <span class="text-xs font-bold text-gray-600">Fayl</span>
            </div>
            <div onclick="sendLocation()" class="flex flex-col items-center gap-2 cursor-pointer">
                <div class="w-16 h-16 bg-green-100 text-green-600 rounded-3xl flex items-center justify-center text-3xl"><i class="fa-solid fa-location-dot"></i></div>
                <span class="text-xs font-bold text-gray-600">Joylashuv</span>
            </div>
        </div>
        <input type="file" id="mediaInp" hidden onchange="handleFile(this)">
    </div>
<!-- ozgatrish kere 1 -->
<div id="profileTab" class="tab-content hidden animate-fade-in bg-[#f2f2f7] min-h-screen pb-32">
    <header class="p-6 pt-12 flex justify-between items-end">
        <div>
            <p class="text-xs font-bold text-blue-600 uppercase tracking-widest mb-1">Mening hisobim</p>
            <h1 class="text-3xl font-black text-gray-900">Profil</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="copyMyID()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm active:scale-90 transition">
                <i class="fa-solid fa-fingerprint text-gray-400"></i>
            </button>
        </div>
    </header>

    <div class="px-4 space-y-4">
        <div class="bg-white rounded-[32px] p-8 shadow-sm border border-gray-100 flex flex-col items-center text-center">
            <div class="relative mb-4">
                <div class="absolute inset-0 bg-blue-500 blur-2xl opacity-20 rounded-full"></div>
                <img id="profileDisplayPic" src="https://ui-avatars.com/api/?name=U&background=007aff&color=fff" class="relative w-28 h-28 rounded-full border-4 border-white object-cover shadow-xl">
                <div class="absolute bottom-1 right-1 w-7 h-7 bg-green-500 border-4 border-white rounded-full"></div>
            </div>
            <h3 id="profileNameDisplay" class="text-2xl font-black text-gray-800">Yuklanmoqda...</h3>
            <p id="profilePhoneDisplay" class="text-gray-400 font-medium text-sm">+998 00 000 00 00</p>
            
            <div class="grid grid-cols-3 gap-4 mt-8 w-full border-t border-gray-50 pt-6">
                <div class="flex flex-col">
                    <span class="text-lg font-black text-gray-800">124</span>
                    <span class="text-[10px] text-gray-400 uppercase font-bold">Xabarlar</span>
                </div>
                <div class="flex flex-col border-x border-gray-50">
                    <span class="text-lg font-black text-gray-800">12</span>
                    <span class="text-[10px] text-gray-400 uppercase font-bold">Guruhlar</span>
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-black text-gray-800">8d</span>
                    <span class="text-[10px] text-gray-400 uppercase font-bold">Online</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm border border-gray-100">
            <div onclick="openSheet('savedMessages')" class="p-4 border-b border-gray-50 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500 text-white rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-bookmark"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Saqlangan xabarlar</span>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-300 text-[10px]"></i>
            </div>
            <div onclick="openSheet('archiveSheet')" class="p-4 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-500 text-white rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-box-archive"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Arxivlangan chatlar</span>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-300 text-[10px]"></i>
            </div>
        </div>
    </div>
</div>

<div id="settingsTab" class="tab-content hidden animate-fade-in bg-[#f2f2f7] min-h-screen pb-32">
    <header class="p-6 pt-12 flex justify-between items-center">
        <h1 class="text-3xl font-black text-gray-900">Sozlamalar</h1>
        <button onclick="switchTab('profile')" class="bg-white px-4 py-2 rounded-full shadow-sm text-blue-600 font-bold text-xs active:scale-90 transition">Tayyor</button>
    </header>

    <div class="px-4 space-y-6">
        <div class="bg-white rounded-[24px] p-6 shadow-sm border border-gray-100">
            <div class="flex items-center gap-4 mb-6">
                <div class="relative">
                    <img id="userAvatar" src="" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md">
                    <label for="avatarInput" class="absolute -bottom-1 -right-1 bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center cursor-pointer border-2 border-white">
                        <i class="fa-solid fa-pen text-[10px]"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <input id="editNameInp" type="text" placeholder="Ism sharif" class="w-full font-bold text-gray-800 bg-transparent border-none focus:ring-0 p-0 text-lg">
                    <input id="editBioInp" type="text" placeholder="Bio qo'shish..." class="w-full text-gray-400 bg-transparent border-none focus:ring-0 p-0 text-xs mt-1">
                </div>
            </div>
            <button onclick="updateAccountInfo()" class="w-full py-2 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs uppercase tracking-wider transition hover:bg-blue-100">O'zgarishlarni saqlash</button>
        </div>

        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm">
            <p class="px-4 py-3 text-[10px] font-bold text-gray-400 uppercase">Xavfsizlik</p>
            <div class="p-4 flex items-center justify-between border-b border-gray-50 active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-red-100 text-red-600 rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-lock"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Ikki bosqichli tekshiruv</span>
                </div>
                <span class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded-md text-nowrap">O'CHIK</span>
            </div>
            <div class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-eye-slash"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Oxirgi ko'rinish</span>
                </div>
                <span class="text-xs text-gray-400 italic">Hamma</span>
            </div>
        </div>

        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm">
             <p class="px-4 py-3 text-[10px] font-bold text-gray-400 uppercase">Interfeys</p>
             <div class="p-4 flex items-center justify-between border-b border-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gray-900 text-white rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-palette"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Tungi rejim</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" onchange="toggleDarkMode(this)" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
            </div>
            <div class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-green-100 text-green-600 rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-globe"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Tilni o'zgartirish</span>
                </div>
                <span class="text-xs text-gray-500">O'zbekcha</span>
            </div>
        </div>

        <div class="bg-white rounded-[24px] overflow-hidden shadow-sm">
            <div onclick="clearCache()" class="p-4 flex items-center justify-between active:bg-gray-50 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center text-xs"><i class="fa-solid fa-database"></i></div>
                    <span class="font-bold text-gray-700 text-sm">Keshni tozalash</span>
                </div>
                <span id="cacheSize" class="text-[10px] text-gray-400 font-bold">24.5 MB</span>
            </div>
        </div>

        <button onclick="logout()" class="w-full py-4 bg-red-50 text-red-600 rounded-2xl font-black shadow-sm active:scale-95 transition border border-red-100 mb-20">Hisobdan chiqish</button>
    </div>
</div>
<!-- ozgartirish kere  -->
<div id="mediaPreviewModal" class="hidden fixed inset-0 z-[5500] bg-black flex flex-col">
    <div class="p-4 flex justify-between items-center text-white">
        <i class="fa-solid fa-xmark text-2xl cursor-pointer" onclick="closeMediaPreview()"></i>
        <span id="mediaTypeTitle" class="font-bold">Media yuborish</span>
        <div></div>
    </div>
    <div class="flex-1 flex items-center justify-center p-4">
        <div id="mediaDisplayArea" class="max-w-full max-h-full"></div>
    </div>
</div>

<div id="adminPanel" class="hidden fixed inset-0 z-[6000] bg-black text-green-400 font-mono p-4 md:p-8 overflow-y-auto" style="display: none;">
    <div class="flex justify-between items-center border-b border-green-700 pb-4 mb-6">
        <div>
            <h2 class="text-2xl font-bold tracking-widest text-green-500">SAFECHAT_OS_v2.0</h2>
            <p class="text-[10px] opacity-70">ROOT_ACCESS: GRANTED</p>
        </div>
        <button onclick="closeAdmin()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded shadow-lg text-sm">TERMINATE_SESSION</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        </div>
</div>

<div id="applySheet" class="ios-sheet">
    <div class="sheet-handle"></div>
    <div class="p-6">
        <h2 class="text-2xl font-black mb-4">Ariza topshirish</h2>
        <div class="space-y-4">
            <input type="text" id="app_name" placeholder="Ism Familiya" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
            <input type="tel" id="app_phone" placeholder="Telefon raqam" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
            <textarea id="app_reason" placeholder="Nima uchun bizga qo'shilmoqchisiz?" class="w-full p-4 bg-gray-100 rounded-2xl outline-none h-32"></textarea>
            <button onclick="submitApplication()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold">Yuborish</button>
        </div>
    </div>
</div>
    <div id="sheetOverlay" class="sheet-overlay" onclick="closeAllSheets()"></div>
<div class="flex flex-col gap-4 items-center justify-center min-h-screen bg-gray-50">
    <h1 class="text-2xl font-bold">SafeChat-ni o'rnating</h1>
    <p class="text-gray-500 text-center px-6">Ilovani asosiy ekranga qo'shish orqali tezkor kirish imkoniga ega bo'ling.</p>
    
    <button id="installBtn" class="hidden bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">
        <i class="fa-brands fa-android mr-2"></i> Android uchun yuklab olish
    </button>

    <button id="iosInstallBtn" class="hidden bg-black text-white px-8 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">
        <i class="fa-brands fa-apple mr-2"></i> iOS uchun o'rnatish
    </button>
</div>
    <script>
        const API = "https://safe-chat-60ot.onrender.com";
        const socket = io(API);
        let currentUser = null;
        let activeChat = null;
        let currentEntityType = 'group';
        let selectedMsgId = null;
        let isEditing = false;
        let currentUploadType = 'file';

        // --- AUTH & CORE ---
        function toggleAuth(isReg) {
            document.getElementById('loginView').classList.toggle('hidden', isReg);
            document.getElementById('registerView').classList.toggle('hidden', !isReg);
        }

async function register() {
    const code = document.getElementById('phoneCode').value;
    const phoneNum = document.getElementById('reg_phone').value.trim();
    const u = document.getElementById('reg_u').value.trim();
    const p = document.getElementById('reg_p').value.trim();

    if(!phoneNum || !u || !p) return alert("Hamma maydonlarni to'ldiring!");

    const fullPhone = code + phoneNum; // Masalan: +998901234567

    try {
        const res = await fetch(`${API}/api/register`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                phone: fullPhone, 
                username: u + ".connect.uz", 
                password: p 
            })
        });
        const d = await res.json();
        if(res.ok) { 
            alert("Muvaffaqiyatli ro'yxatdan o'tdingiz!"); 
            toggleAuth(false); 
        } else { 
            alert(d.message); 
        }
    } catch(e) { 
        alert("Server bilan ulanishda xato!"); 
    }
}

async function login() {
    let u = document.getElementById('login_u').value.trim();
    const p = document.getElementById('login_p').value.trim();

    // 1ï¸âƒ£ Maydonlar boâ€˜sh boâ€˜lsa
    if (!u || !p) {
        alert("Iltimos, username va parolni to'ldiring!");
        return;
    }

    try {
        // 2ï¸âƒ£ API ga login soâ€˜rovi
        const res = await fetch(`${API}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: u,
                password: p
            })
        });

        const d = await res.json();

        // 3ï¸âƒ£ Login muvaffaqiyatli bo'lsa
        if (res.ok) {
            currentUser = d.username;

            // LocalStorage ga saqlaymiz
            localStorage.setItem("chat_user", d.username);
            if (d.phone) {
                localStorage.setItem("user_phone", d.phone);
            }

            // UI ni yangilash
            document.getElementById("authScreen").classList.add("hidden");
            document.getElementById("mainApp").classList.remove("hidden");

            // SOCKET orqali tizimga qoâ€˜shish
            socket.emit("join", { username: d.username });

            // Admin tekshiruvi
            if (typeof checkAdminAccess === "function") {
                checkAdminAccess();
            }

            // Dastlabki yuklanish funksiyasi boâ€˜lsa chaqiramiz
            if (typeof initApp === "function") {
                initApp();
            }

        } else {
            // 4ï¸âƒ£ Noaniq xatoda aniq habar
            alert("Xato: " + (d.message || "Login amalga oshmadi!"));
        }

    } catch (err) {
        // 5ï¸âƒ£ Serverga ulanishda muammo â€” internet yoki API ishlamayapti
        console.error("Ulanish xatosi:", err);
        alert("Server bilan ulanishda xato! Iltimos qayta urinib koâ€˜ring.");
    }
}

// Qidiruv maydonini ochish/yopish
function toggleSearch() {
    const searchContainer = document.getElementById('searchBarContainer');
    searchContainer.classList.toggle('hidden');

    // Agar qidiruv ochilsa, inputga fokus berish
    if(!searchContainer.classList.contains('hidden')) {
        document.getElementById('userSearch').focus();
    }
}

// Universal search (chat, group, channel)
function universalSearch(query) {
    query = query.toLowerCase();

    // Chatlarni filtrlash
    document.querySelectorAll('#chatList .chat-item').forEach(chat => {
        chat.style.display = chat.innerText.toLowerCase().includes(query) ? '' : 'none';
    });

    // Guruhlarni filtrlash
    document.querySelectorAll('#groupList .group-item').forEach(group => {
        group.style.display = group.innerText.toLowerCase().includes(query) ? '' : 'none';
    });

    // Kanallarni filtrlash
    document.querySelectorAll('#channelsTab .channel-item').forEach(channel => {
        channel.style.display = channel.innerText.toLowerCase().includes(query) ? '' : 'none';
    });
}

function updateNavUI(tabName) {
    const btn = document.getElementById(`nav-${tabName}`);
    const indicator = document.getElementById('navIndicator');
    if (btn && indicator) {
        indicator.style.width = `${btn.offsetWidth}px`;
        indicator.style.left = `${btn.offsetLeft}px`;
    }
}

function switchTab(tab) {
    // 1. Barcha tugmalardan faol rangni olib tashlash
    document.querySelectorAll('.nav-item').forEach(i => {
        i.classList.remove('text-[#007aff]');
        i.classList.add('text-gray-400');
    });

    // 2. Tanlangan tugmani faollashtirish
    const navBtn = document.getElementById(`nav-${tab}`);
    if (navBtn) {
        navBtn.classList.remove('text-gray-400');
        navBtn.classList.add('text-[#007aff]');

        // --- ANIMATSIYA (INDICATOR) QISMI ---
        const indicator = document.getElementById('navIndicator');
        if (indicator) {
            // Indikator kengligini va joylashuvini tugmaga qarab moslash
            indicator.style.width = `${navBtn.offsetWidth}px`;
            indicator.style.left = `${navBtn.offsetLeft}px`;
        }
    }

    // 3. Kontentni almashtirish (Hidden klassini boshqarish)
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    const tabCont = document.getElementById(`${tab}Tab`);
    if (tabCont) {
        tabCont.classList.remove('hidden');
    }

    // 4. Sarlavhani yangilash
    const titles = { 'chats': 'Chatlar', 'groups': 'Ommaviy', 'settings': 'Sozlamalar', 'profile': 'Profil' };
    if(document.getElementById('tabTitle')) {
        document.getElementById('tabTitle').innerText = titles[tab] || 'SafeChat';
    }
}


async function loadList(tab) {
    // 1. To'g'ri konteynerni tanlash (Ommaviy va Chatlar uchun)
    let list;
    if (tab === 'chats') {
        list = document.getElementById('chatList');
    } else {
        list = document.getElementById(`${tab}Tab`);
    }

    if (!list) return; // Agar element topilmasa funksiyani to'xtatish

    // Yuklanish indikatori
    if (list.innerHTML.trim() === "") {
        list.innerHTML = `<div class="text-center py-10 text-gray-400 text-xs animate-pulse">Ma'lumotlar yuklanmoqda...</div>`;
    }

    try {
        if (tab === 'chats') {
            const res = await fetch(`${API}/api/recent_chats?username=${currentUser}`);
            const contacts = await res.json();

            list.innerHTML = ""; 

            if (contacts.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-20 opacity-60">
                        <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-comments text-3xl text-blue-500"></i>
                        </div>
                        <p class="text-gray-800 text-sm font-bold">Suhbatlar hali yo'q</p>
                        <p class="text-gray-400 text-[11px] px-10">Kimnidir topish uchun qidiruvdan foydalaning.</p>
                    </div>`;
            } else {
                contacts.forEach(contact => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-4 bg-white rounded-2xl cursor-pointer hover:bg-blue-50 transition-all duration-200 shadow-sm mb-2 active:scale-[0.98] border border-gray-50 group";
                    
                    // contact ob'ekt yoki string bo'lishiga qarab ism olish
                    const name = typeof contact === 'object' ? contact.username : contact;
                    const isOnline = typeof contact === 'object' ? contact.is_online : false;

                    div.innerHTML = `
                        <div class="relative">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007aff&color=fff" class="w-13 h-13 rounded-full border-2 border-white shadow-sm">
                            ${isOnline ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <h5 class="font-bold text-[14px] text-gray-800 truncate">${name}</h5>
                                <span class="text-[10px] text-gray-400">Hozir</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-[12px] text-gray-400 truncate pr-4">Suhbatni boshlash...</p>
                                <div class="w-2 h-2 bg-blue-600 rounded-full ${typeof contact === 'object' && contact.unread ? '' : 'hidden'}" id="unread-${name}"></div>
                            </div>
                        </div>
                    `;
                    
                    div.onclick = () => openChat(name);
                    list.appendChild(div);
                });
            }
        } else if (tab === 'groups') {
            const res = await fetch(`${API}/api/entities?username=${currentUser}`);
            const entities = await res.json();
            const filtered = entities.filter(e => e.type === 'group');

            list.innerHTML = "";
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-gray-400 text-xs mb-4">Hozircha guruhlar yo'q.</p>
                        <button onclick="openSheet('createEntitySheet')" class="text-blue-600 font-bold text-xs uppercase">+ Guruh yaratish</button>
                    </div>`;
            } else {
                // Sarlavha qo'shish (ixtiyoriy)
                const header = document.createElement('h2');
                header.className = "text-xl font-black p-4 text-gray-800";
                header.innerText = "Guruhlar";
                list.appendChild(header);

                filtered.forEach(ent => {
                    const div = document.createElement('div');
                    div.className = "p-4 bg-white rounded-2xl shadow-sm mb-2 cursor-pointer hover:bg-gray-50 transition flex items-center gap-4 mx-4";
                    div.innerHTML = `
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-xl shadow-lg">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-sm text-gray-800">${ent.name}</h3>
                            <p class="text-[11px] text-gray-400">Guruh suhbati â€¢ ${ent.member_count || 0} a'zo</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    `;
                    div.onclick = () => openChat(ent.name);
                    list.appendChild(div);
                });
            }
        }
    } catch (e) {
        console.error("Xatolik:", e);
        list.innerHTML = `<div class="text-center py-10 text-red-400 text-xs">Xatolik: Serverga ulanib bo'lmadi.</div>`;
    }
}

// QIDIRUV FUNKSIYASI (O'zgarishsiz qoladi, lekin openChat ni to'g'ri chaqiradi)
const toggleBtn = document.getElementById('toggleSearch');
    const searchWrapper = document.getElementById('searchWrapper');

    toggleBtn.addEventListener('click', () => {
        // Qidiruv oynasini ochish/yopish
        searchWrapper.classList.toggle('hidden');
        // focus input, agar ochilgan bo'lsa
        if(!searchWrapper.classList.contains('hidden')){
            document.getElementById('userSearch').focus();
        }
    });

    // QIDIRUV FUNKSIYASI (o'zgarmadi)
    async function liveSearch(val) {
        const list = document.getElementById('chatList');
        if (val.length < 1) { loadList('chats'); return; }

        try {
            const res = await fetch(`${API}/api/users/search`);
            const users = await res.json();
            const filtered = users.filter(u => u.username.toLowerCase().includes(val.toLowerCase()) && u.username !== currentUser);

            list.innerHTML = "";
            if(filtered.length === 0) {
                list.innerHTML = `<p class="text-center text-red-400 mt-10 text-sm">Foydalanuvchi topilmadi</p>`;
                return;
            }

            filtered.forEach(u => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-4 bg-white rounded-2xl cursor-pointer hover:bg-blue-50 transition shadow-sm mb-2 active:scale-95";
                div.innerHTML = `
                    <img src="https://ui-avatars.com/api/?name=${u.username}&background=007aff&color=fff" class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <h5 class="font-bold text-sm text-gray-800">${u.username}</h5>
                        <p class="text-[10px] text-blue-500 font-medium">Yangi suhbat boshlash</p>
                    </div>
                `;
                div.onclick = () => openChat(u.username);
                list.appendChild(div);
            });
        } catch(e) { console.error("Search error", e); }
    }

async function openChat(name) {
    activeChat = name;
    const chatArea = document.getElementById('chatArea');
    
    // 1. Chat oynasini ko'rinadigan qilish (CSS dagi display: none ni yengish uchun)
    chatArea.style.display = 'flex'; 
    chatArea.classList.remove('hidden');
    
    // 2. Suhbatdosh ma'lumotlarini yangilash
    document.getElementById('activeName').innerText = name;
    document.getElementById('activeChatImg').src = `https://ui-avatars.com/api/?name=${name}&background=007aff&color=fff`;
    
    // Xabarlar oynasini tozalash va yuklanayotganini ko'rsatish (ixtiyoriy)
    const msgBox = document.getElementById('msgBox');
    msgBox.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs">Yuklanmoqda...</div>'; 
    
    // 3. Xabarlar tarixini serverdan yuklash
    try {
        const res = await fetch(`${API}/api/messages?user1=${currentUser}&user2=${name}`);
        if (res.ok) {
            const msgs = await res.json();
            msgBox.innerHTML = ""; // Yuklanmoqda yozuvini o'chirish
            if(msgs.length === 0) {
                msgBox.innerHTML = '<div class="text-center py-10 text-gray-300 text-xs">Xabarlar mavjud emas</div>';
            } else {
                msgs.forEach(appendMessage);
            }
        }
    } catch(e) { 
        console.log("Xabarlarni yuklashda xato:", e);
        msgBox.innerHTML = '<div class="text-center py-10 text-red-400 text-xs">Xabarlarni yuklab bo\'lmadi</div>';
    }

    // 4. Ochiq turgan barcha menyularni yopish
    closeAllSheets();
}
/////menuni tepaga chiqaradi 
function fixMobileHeight() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('resize', fixMobileHeight);
window.addEventListener('load', fixMobileHeight);
fixMobileHeight();

function sendMsg(type = 'text', content = null) {
    const inp = document.getElementById('msgInp');
    const val = content || inp.value.trim();
    
    // Agar xabar bo'sh bo'lsa yoki chat tanlanmagan bo'lsa chiqib ketish
    if (!val || !activeChat) return;

    if (isEditing) {
        // --- TAHRIRLASH REJIMI ---
        socket.emit('edit_message', { 
            id: selectedMsgId, 
            content: val, 
            receiver: activeChat 
        });
        
        // Tahrirlashni yakunlash va tugma ikonkasini qaytarish
        isEditing = false;
        selectedMsgId = null; 
        document.getElementById('sendBtnIcon').className = "fa-solid fa-arrow-up";
        
    } else {
        // --- YANGI XABAR YUBORISH REJIMI ---
        const data = { 
            sender: currentUser, 
            receiver: activeChat, 
            content: val, 
            // Reply ma'lumotlarini qo'shish
            reply_to: replyToId ? { 
                id: replyToId, 
                text: replyToText, 
                sender: replyToSender 
            } : null,
            type: type 
        };

        // Serverga yuborish
        socket.emit('send_message', data);
        
        // --- MUHIM: Reply rejimini tozalash ---
        if (replyToId) {
            cancelReply(); // Reply oynasini yopish va o'zgaruvchilarni nolga tushirish
        }
    }
    
    // Inputni tozalash va fokusni qaytarish
    if (!content) {
        inp.value = "";
        inp.focus();
    }
}

function updateHeight() {
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

window.addEventListener('resize', updateHeight);
window.addEventListener('load', updateHeight);
updateHeight();

function appendMessage(data) {
    const box = document.getElementById('msgBox');
    const isMe = data.sender === currentUser;
    
    // 1. Multimedia qismini tayyorlash
    let mediaHTML = "";
    if (data.type === 'image') {
        mediaHTML = `<img src="${data.file_data || data.content}" class="max-w-full rounded-lg cursor-pointer mb-2 shadow-sm" onclick="viewImage(this.src)">`;
    } else if (data.type === 'video') {
        mediaHTML = `<video src="${data.file_data}" controls class="max-w-full rounded-lg mb-2 shadow-sm"></video>`;
    } else if (data.type === 'location') {
        mediaHTML = `
            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 mb-2">
                <a href="${data.content}" target="_blank" class="text-blue-600 text-sm flex items-center gap-2 font-medium">
                    <i class="fa-solid fa-map-location-dot"></i> ðŸ“ Joylashuvni ko'rish
                </a>
            </div>`;
    }

    // 2. Matn (kontent) qismini tayyorlash
    // Agar bu location bo'lsa, linkni matn sifatida qayta ko'rsatmaymiz
    let textHTML = (data.type !== 'location' && data.content && data.content.trim() !== "") 
                   ? `<p class="text-sm leading-relaxed">${data.content}</p>` 
                   : "";

    // 3. Reply (javob) qismi
    let replyMarkup = "";
    if (data.reply_to) {
        replyMarkup = `
            <div class="bg-black/5 border-l-2 border-blue-500 p-1.5 mb-2 rounded text-[11px] opacity-80 cursor-pointer" onclick="scrollToMessage('${data.reply_to.id}')">
                <b class="text-blue-600 block">${data.reply_to.sender}</b>
                <p class="truncate text-gray-600">${data.reply_to.text}</p>
            </div>`;
    }

    // 4. Konteyner yaratish
    const container = document.createElement('div');
    container.id = `container-${data.id}`;
    container.className = `msg-container flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-3 px-4 w-full`;
    
    container.innerHTML = `
        <div class="msg-bubble relative max-w-[85%] p-2.5 rounded-2xl shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'}" 
            id="msg-${data.id}">
            ${replyMarkup}
            <div class="msg-body">
                ${mediaHTML}
                ${textHTML}
            </div>
            <div class="flex items-center justify-end gap-1 mt-1 opacity-60">
                <span class="text-[9px]">${data.timestamp}</span>
                ${isMe ? '<i class="fa-solid fa-check-double text-[8px]"></i>' : ''}
            </div>
        </div>
    `;

    box.appendChild(container);
    
    // 5. Hodisalarni bog'lash
    const bubble = container.querySelector('.msg-bubble');
    bindContextEvents(bubble, data); 
    initSwipe(bubble, data.id, data.content, data.sender);
    
    // Skrolni pastga tushirish
    box.scrollTop = box.scrollHeight;
}
function refreshProfileUI() {
    const name = localStorage.getItem('username') || 'Foydalanuvchi';
    const phone = localStorage.getItem('user_phone') || '+998 -- --- -- --';
    const bio = localStorage.getItem('user_bio') || 'Bio hali yozilmagan...';

    // Inputlar
    document.getElementById('editNameInp').value = name;
    document.getElementById('editBioInp').value = bio === 'Bio hali yozilmagan...' ? '' : bio;
    
    // Matnlar
    document.getElementById('profileNameDisplay').innerText = name;
    document.getElementById('profilePhoneDisplay').innerText = phone;
    document.getElementById('displayUsername').innerText = '@' + name.toLowerCase().replace(/\s/g, '_');
    document.getElementById('displayBio').innerText = bio;

    // Avatar
    const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007aff&color=fff&size=128`;
    document.getElementById('profileDisplayPic').src = avatar;
    document.getElementById('userAvatar').src = avatar;
}

function copyMyID() {
    const myID = "SC-" + Math.floor(Math.random() * 900000 + 100000);
    navigator.clipboard.writeText(myID);
    alert("Sizning SafeChat ID-ingiz nusxalandi: " + myID);
}
        // --- CONTEXT MENU ACTIONS ---
        function showContextMenu(e, msgId) {
            selectedMsgId = msgId;
            const menu = document.getElementById('msgContextMenu');
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px';
            document.getElementById('sheetOverlay').classList.add('active');
        }

        function copyMsg() {
            const txt = document.getElementById(`msg-${selectedMsgId}`).innerText;
            navigator.clipboard.writeText(txt);
            closeAllSheets();
        }

        function startEditMsg() {
            isEditing = true;
            const txt = document.getElementById(`msg-${selectedMsgId}`).innerText;
            document.getElementById('msgInp').value = txt;
            document.getElementById('msgInp').focus();
            document.getElementById('sendBtnIcon').className = "fa-solid fa-check";
            closeAllSheets();
        }

        function deleteMsgServer() {
            socket.emit('delete_message', { id: selectedMsgId, receiver: activeChat });
            document.getElementById(`msg-${selectedMsgId}`).remove();
            closeAllSheets();
        }

// --- MEDIA & TOOLS ---

let pendingFileData = null;
let pendingFileType = null;

// 1. Fayl tanlash
function triggerMediaUpload(type) {
    const input = document.createElement('input');
    input.type = 'file';
    if (type === 'image') input.accept = 'image/*';
    else if (type === 'video') input.accept = 'video/*';
    else input.accept = '*/*';

    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            pendingFileData = event.target.result; // Base64
            pendingFileType = type;
            showMediaPreview(pendingFileData, type);
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

const countries = [
    { name: "Uzbekistan", code: "+998", flag: "ðŸ‡ºðŸ‡¿" },
    { name: "Russia", code: "+7", flag: "ðŸ‡·ðŸ‡º" },
    { name: "USA", code: "+1", flag: "ðŸ‡ºðŸ‡¸" },
    { name: "Turkey", code: "+90", flag: "ðŸ‡¹ðŸ‡·" },
    { name: "Kazakhstan", code: "+7", flag: "ðŸ‡°ðŸ‡¿" },
    { name: "Germany", code: "+49", flag: "ðŸ‡©ðŸ‡ª" },
    { name: "United Kingdom", code: "+44", flag: "ðŸ‡¬ðŸ‡§" },
    { name: "South Korea", code: "+82", flag: "ðŸ‡°ðŸ‡·" },
    { name: "Kyrgyzstan", code: "+996", flag: "ðŸ‡°ðŸ‡¬" },
    { name: "Tajikistan", code: "+992", flag: "ðŸ‡¹ðŸ‡¯" }
];

function openCountryModal() {
    document.getElementById('countryModal').classList.remove('hidden');
    renderCountries(countries);
}

function closeCountryModal() {
    document.getElementById('countryModal').classList.add('hidden');
}

function renderCountries(list) {
    const container = document.getElementById('countryList');
    container.innerHTML = "";
    list.forEach(c => {
        const item = document.createElement('div');
        item.className = "flex items-center justify-between p-4 border-b hover:bg-gray-50 cursor-pointer transition";
        item.innerHTML = `
            <div class="flex items-center gap-4">
                <span class="text-2xl">${c.flag}</span>
                <span class="font-medium text-gray-700">${c.name}</span>
            </div>
            <span class="text-gray-400 font-bold">${c.code}</span>
        `;
        item.onclick = () => {
            document.getElementById('selectedFlag').innerText = c.flag;
            document.getElementById('selectedCountryName').innerText = c.name;
            document.getElementById('phoneCode').value = c.code;
            closeCountryModal();
        };
        container.appendChild(item);
    });
}

function filterCountries() {
    const term = document.getElementById('countrySearch').value.toLowerCase();
    const filtered = countries.filter(c => c.name.toLowerCase().includes(term));
    renderCountries(filtered);
}

// 2. Preview oynasini ochish
function showMediaPreview(data, type) {
    const modal = document.getElementById('mediaPreviewModal');
    const display = document.getElementById('mediaDisplayArea');
    modal.classList.remove('hidden');

    if (type === 'image') {
        display.innerHTML = `<img src="${data}" class="max-w-full max-h-[60vh] rounded-lg shadow-2xl">`;
    } else if (type === 'video') {
        display.innerHTML = `<video src="${data}" controls class="max-w-full max-h-[60vh] rounded-lg"></video>`;
    }
}

function closeMediaPreview() {
    document.getElementById('mediaPreviewModal').classList.add('hidden');
    pendingFileData = null;
}

// 1. Hisob ma'lumotlarini yangilash
function updateAccountInfo() {
    const newName = document.getElementById('editNameInp').value;
    const newBio = document.getElementById('editBioInp').value;

    if (newName.trim()) {
        localStorage.setItem('username', newName);
        localStorage.setItem('user_bio', newBio);
        
        // UI ni darhol yangilash
        document.getElementById('profileNameDisplay').innerText = newName;
        document.getElementById('displayUsername').innerText = '@' + newName.toLowerCase().replace(/\s/g, '_');
        
        alert("Ma'lumotlar saqlandi!");
    }
}

function clearCache() {
    if (confirm("Keshni tozalamoqchimisiz? Bu rasmlarni qayta yuklanishiga sabab bo'ladi.")) {
        document.getElementById('cacheSize').innerText = "0.0 MB";
        alert("Kesh muvaffaqiyatli tozalandi!");
    }
}

// 3. Tasdiqlash va Yuborish
function confirmAndSendMedia() {
    if (!pendingFileData) return;
    
    const caption = document.getElementById('mediaCaption').value;
    
    const data = {
        sender: currentUser,
        receiver: activeChat,
        content: caption || (pendingFileType === 'image' ? "ðŸ–¼ Rasm" : "ðŸ“¹ Video"),
        file_data: pendingFileData,
        type: pendingFileType,
        reply_to: replyToId ? { id: replyToId, text: replyToText, sender: replyToSender } : null,
        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };

    socket.emit('send_message', data);
    
    // Tozalash
    closeMediaPreview();
    document.getElementById('mediaCaption').value = "";
    cancelReply(); // Agar reply bo'lsa
}

// 4. Location yuborish (Preview shart emas, birdan ketadi)
function sendLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const locData = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            socket.emit('send_message', {
                sender: currentUser,
                receiver: activeChat,
                type: 'location',
                content: `Joylashuv: ${locData.lat}, ${locData.lng}`,
                location: locData // Serverga obyekt sifatida yuboramiz
            });
            closeSheet('mediaSheet');
        });
    } else {
        alert("Geolokatsiya qurilmangizda qo'llab-quvvatlanmaydi.");
    }
}
        function setEntityType(type) {
            currentEntityType = type;
            document.getElementById('btnTypeGroup').classList.toggle('bg-white', type === 'group');
            document.getElementById('btnTypeChannel').classList.toggle('bg-white', type === 'channel');
        }

        function submitNewEntity() {
            const name = document.getElementById('entityName').value;
            socket.emit('create_entity', { type: currentEntityType, name, creator: currentUser });
            alert(name + " yaratildi!");
            closeAllSheets();
        }

                    socket.on("entity_created", (data) => {
                if (data.type === "group") {
                    addToGroupList(data.name);
                } else {
                    addToChannelList(data.name);
                }
            });

        function openUserMenu() {
            const block = confirm(activeChat + " foydalanuvchini bloklash?");
            if(block) socket.emit('block_user', { target: activeChat });
        }

        function initiateCall(type) {
            alert(type + " qo'ng'iroq signali yuborilmoqda...");
            socket.emit('call_signal', { to: activeChat, type: type });
        }
        // guruh va kanallar qoshish uchun yangi funksiya 
        let entityType = "group"; // default

function setEntityType(type) {
    entityType = type;

    document.getElementById("btnTypeGroup").classList.toggle("bg-white", type === "group");
    document.getElementById("btnTypeGroup").classList.toggle("text-gray-800", type === "group");
    document.getElementById("btnTypeGroup").classList.toggle("text-gray-500", type !== "group");

    document.getElementById("btnTypeChannel").classList.toggle("bg-white", type === "channel");
    document.getElementById("btnTypeChannel").classList.toggle("text-gray-800", type === "channel");
    document.getElementById("btnTypeChannel").classList.toggle("text-gray-500", type !== "channel");
}

function createEntity() {
    const name = document.getElementById("entityName").value.trim();
    if (name.length < 2) {
        alert("Nomi juda qisqa!");
        return;
    }

    // Backendga yuboriladi
    socket.emit("create_entity", { 
        type: entityType,
        name: name 
    });

    // UIga qoâ€˜shib qoâ€˜yamiz (real vaqtda koâ€˜rinishi uchun)
    if (entityType === "group") {
        addToGroupList(name);
    } else {
        addToChannelList(name);
    }

    closeSheet();
}

// Frontendga yangi element qoâ€˜shish
function addToGroupList(name) {
    const box = document.getElementById("groupsTab");
    box.innerHTML += `
        <div class="p-4 bg-white rounded-2xl shadow-sm">
            <h3 class="text-lg font-bold">${name}</h3>
            <p class="text-gray-500 text-sm">Yangi guruh</p>
        </div>
    `;
}

function addToChannelList(name) {
    const box = document.getElementById("channelsTab");
    box.innerHTML += `
        <div class="p-4 bg-white rounded-2xl shadow-sm">
            <h3 class="text-lg font-bold">${name}</h3>
            <p class="text-gray-500 text-sm">Yangi kanal</p>
        </div>
    `;
}

function createEntity() {
    const type = currentEntityType; 
    const name = document.getElementById("entityName").value.trim();

    if (!name) return alert("Nomi boâ€˜sh boâ€˜lmasin!");

    socket.emit("create_entity", {
        type: type,
        name: name
    });

    closeSheet('createEntitySheet');
    document.getElementById("entityName").value = "";
}

// --- UI HELPERS (YANGILANGAN) ---
        function openSheet(id) { 
            document.getElementById(id).classList.add('active'); 
            document.getElementById('sheetOverlay').classList.add('active'); 
        }

        function closeSheet(id) { 
            document.getElementById(id).classList.remove('active'); 
            document.getElementById('sheetOverlay').classList.remove('active'); 
        }

        function closeAllSheets() {
            // Hamma sheetlarni yopish
            document.querySelectorAll('.ios-sheet').forEach(s => s.classList.remove('active'));
            // Overlayni yopish
            document.getElementById('sheetOverlay').classList.remove('active');
            // Kontekst menyuni yashirish
            document.getElementById('msgContextMenu').style.display = 'none';
        }

        function handleEnter(e) { 
            if(e.key === 'Enter') sendMsg(); 
        }
        function handleReply() {
        setupReply(selectedMsgId, selectedMsgText, selectedMsgSender);
        closeMenu(); // BU MUHIM!
        }

        // 1. CHATNI YOPISH FUNKSIYASI
function closeChatArea() { 
    const chatArea = document.getElementById('chatArea');
    chatArea.style.display = 'none'; 
    chatArea.classList.add('hidden'); 
    chatArea.classList.remove('flex');
    activeChat = null; 
    
    const searchInp = document.querySelector('input[type="search"]');
    if(searchInp) searchInp.value = "";
}

// 2. ADMIN LOGIN FUNKSIYASI
function showAdminLogin() {
    const key = prompt("ENTER ROOT_KEY:");
    if (key === 'serinaqu') {
        const panel = document.getElementById('adminPanel');
        panel.style.display = 'block';
        panel.classList.remove('hidden');
        loadAdminData();
        addLog("ADMIN_SESSION_STARTED", "success");
    } else {
        alert("ACCESS_DENIED: INVALID_KEY");
    }
}

// 3. ADMIN PANELNI YOPISH
function closeAdmin() {
    const panel = document.getElementById('adminPanel');
    panel.style.display = 'none';
    panel.classList.add('hidden');
}

// 4. ADMIN LOG QO'SHISH
function addLog(msg, type = "info") {
    const logContainer = document.getElementById('adminLogs');
    if(!logContainer) return;
    const time = new Date().toLocaleTimeString();
    const color = type === "success" ? "text-green-400" : type === "danger" ? "text-red-500" : "text-blue-400";
    logContainer.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 5. ADMIN DATA YUKLASH
async function loadAdminData() {
    try {
        const response = await fetch(`${API}/api/admin/users`);
        const users = await response.json();
        const table = document.getElementById('adminTable');
        if(!table) return;
        table.innerHTML = "";
        
        users.forEach(u => {
            const row = `
                <tr class="hover:bg-green-900/20 transition-colors border-b border-green-900/30">
                    <td class="p-3 font-bold">${u.name}</td>
                    <td class="p-3">USER</td>
                    <td class="p-3">
                        <span class="w-2 h-2 inline-block rounded-full ${u.status === 'ONLINE' ? 'bg-green-500' : 'bg-gray-600'} mr-2"></span>
                        ${u.status}
                    </td>
                    <td class="p-3 ${u.is_blocked ? 'text-red-500' : 'text-green-500'}">${u.is_blocked ? 'BANNED' : 'CLEAR'}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="toggleBan('${u.name}')" class="bg-red-900/50 border border-red-700 px-2 py-1 rounded text-[10px] hover:bg-red-700">BAN/UNBAN</button>
                    </td>
                </tr>`;
            table.innerHTML += row;
        });
        document.getElementById('totalUsersStat').innerText = users.length;
    } catch(e) { 
        addLog("DATA_LOAD_FAILED", "danger"); 
    }
}

// 6. E'LONNI CHIQARISH (BROADCAST)
function publishAnnouncement() {
    const type = document.getElementById('advType').value;
    const value = document.getElementById('advValue').value;
    const start = document.getElementById('advStart').value;
    const end = document.getElementById('advEnd').value;

    if(!value) return alert("E'lon matni yoki linkini kiriting!");

    const config = { type, value, start, end };
    socket.emit('broadcast_announcement', config);
    addLog(`BROADCAST_DEPLOYED: ${type}`, "success");
    alert("E'lon barcha foydalanuvchilarga yuborildi!");
}

        // TIZIMDAN CHIQISH (To'liq tozalash bilan)
        function logout() {
            if(confirm("Tizimdan chiqmoqchimisiz?")) {
                currentUser = null;
                activeChat = null;
                // Sahifani qayta yuklash orqali barcha o'zgaruvchilarni nolga tushiramiz
                window.location.reload(); 
            }
        }

        // PROFILNI SAQLASH TUGMASI UCHUN
        function saveProfile() {
            alert("Profil ma'lumotlari muvaffaqiyatli saqlandi!");
            closeSheet('settingsSheet');
        }
        // Foydalanuvchi login qilgandan keyin bu ishga tushadi
        function onUserLoggedIn() {
            currentUser = localStorage.getItem('chat_user'); // Agar saqlangan bo'lsa
            if(currentUser) {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                switchTab('chats'); // Birinchi bo'lib chatlar bo'limi ochiladi
            }
        }
// --- SOCKET REAL-TIME ---

// 1. Ovozli xabarnoma fayli (Istalgan qisqa mp3 linkini qo'yishingiz mumkin)
const msgSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

// --- SOCKET REAL-TIME ---

socket.on('receive_message', (data) => {
    console.log("Yangi xabar keldi:", data);

    // 1. Ovoz va Titrash (Agar xabar sizdan chiqmagan bo'lsa)
    if (data.sender !== currentUser) {
        msgSound.play().catch(e => console.error("Ovoz xatosi:", e));
        if (navigator.vibrate) navigator.vibrate(200);
    }

    // 2. Chat oynasini yangilash
    // Shart: Agar hozirgi ochiq suhbatdoshimiz xabar yuborgan bo'lsa YOKI biz yuborgan bo'lsak
    if (activeChat === data.sender || (activeChat === data.receiver && data.sender === currentUser)) {
        appendMessage(data);
        
        // Xabarlar oynasini avtomatik pastga tushirish
        const msgBox = document.getElementById('msgBox');
        if (msgBox) {
            msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });
        }
    } else {
        // Agar foydalanuvchi boshqa chatda yoki boshqa tabda bo'lsa
        showToast(`Yangi xabar: ${data.sender}`, data.content);
    }

    // 3. MUHIM: Har doim chatlar ro'yxatini yangilash (loadList)
    // Bu xabar yuborgan odamni "Chatlar" bo'limida eng tepaga chiqaradi
    // Foydalanuvchi qaysi tabda bo'lishidan qat'i nazar, fon rejimida yangilanadi
    if (typeof loadList === "function") {
        // Biz faqat ma'lumotni yangilaymiz, tabni o'zgartirmaymiz
        refreshChatListSilently(); 
    }
});

// Fon rejimida ro'yxatni yangilash uchun yordamchi funksiya
async function refreshChatListSilently() {
    const chatList = document.getElementById('chatList');
    if (!chatList) return;

    try {
        const res = await fetch(`${API}/api/recent_chats?username=${currentUser}`);
        const contacts = await res.json();
        
        // Faqat "Chatlar" ro'yxati ichini qayta chizamiz
        // Bu foydalanuvchi ko'rib turgan tabga xalaqit bermaydi
        renderChatList(contacts); 
    } catch (e) {
        console.log("Ro'yxatni yangilashda xato:", e);
    }
}

// Chiroyli bildirishnoma ko'rsatish funksiyasi
function showToast(title, body) {
    // Brauzer bildirishnomasi
    if (Notification.permission === "granted") {
        new Notification(title, { 
            body: body, 
            icon: 'https://ui-avatars.com/api/?name=SafeChat&background=007aff&color=fff' 
        });
    } else if (Notification.permission !== "denied") {
        // Agar hali ruxsat so'ralmagan bo'lsa
        Notification.requestPermission();
    }
}

// Sahifa yuklanganda bildirishnomaga ruxsat so'rash
window.addEventListener('load', () => {
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});

        let deferredPrompt;
const installBanner = document.getElementById('installBanner');

// 1. Dastlab banner yashirin bo'lishi kerak (CSS orqali ham yashirish mumkin)
installBanner.style.display = 'none';

window.addEventListener('beforeinstallprompt', (e) => {
    // Brauzerning standart oynasini to'xtatib turamiz
    e.preventDefault();
    deferredPrompt = e;
    // Endi biz o'zimizning bannerni ko'rsatsak bo'ladi
    installBanner.style.display = 'flex';
});

async function installApp() {
    if (!deferredPrompt) return;
    
    // O'rnatish oynasini ko'rsatish
    deferredPrompt.prompt();
    
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
        console.log('Foydalanuvchi ilovani o\'rnatdi');
    }
    
    // Banner bir marta ko'rsatilgach yashiriladi
    installBanner.style.display = 'none';
    deferredPrompt = null;
}

let replyToId = null;
let replyToText = "";
let replyToSender = "";
let selectedMessages = new Set();
let isSelectionMode = false;

// 1. Tanlash rejimini yoqish
function toggleSelectMode() {
    isSelectionMode = true;
    document.body.classList.add('selection-mode');
    document.getElementById('selectionBar').classList.remove('hidden');
    closeMenu();
}

// 2. Habarni tanlash/bekor qilish
function toggleMsgSelection(id) {
    if (!isSelectionMode) return;
    const el = document.getElementById(`container-${id}`);
    if (selectedMessages.has(id)) {
        selectedMessages.delete(id);
        el.classList.remove('selected');
    } else {
        selectedMessages.add(id);
        el.classList.add('selected');
    }
}

function showMenu(e, id, content, isMe) {
    const menu = document.getElementById('msgContextMenu');
    const msgElement = document.getElementById(`msg-${id}`);
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    if (!msgElement) return;

    // 1. XAVFSIZLIK: Faqat o'z xabari bo'lsa Tahrirlash va O'chirishni ko'rsatish
    // isMe argumenti appendMessage'dan keladi (data.sender === currentUser)
    if (isMe) {
        editBtn.style.display = "flex";
        deleteBtn.style.display = "flex";
    } else {
        editBtn.style.display = "none";
        deleteBtn.style.display = "none";
    }

    // 2. Koordinatalarni olish
    const rect = msgElement.getBoundingClientRect();
    menu.style.display = 'block';
    menu.classList.remove('hidden');

    // 3. POZITSIYA: Xabarning markaziga yaqinroq joylashtirish
    // Xabarning balandligi o'rtasidan biroz yuqoriroq
    let top = rect.top + (rect.height / 4); 
    let left;

    if (isMe) {
        // Mening xabarim (o'ngda): Menyu xabarning chap burchagiga yaqin chiqadi
        left = rect.left - (menu.offsetWidth / 2);
    } else {
        // Birovning xabari (chapda): Menyu xabarning o'ng burchagiga yaqin chiqadi
        left = rect.right - (menu.offsetWidth / 2);
    }

    // 4. EKRAN CHEGARALARI: Menyu ekrandan chiqib ketmasligi uchun
    const padding = 15; // Ekran chetidan masofa
    
    // Gorizontal tekshiruv
    if (left < padding) left = padding;
    if (left + menu.offsetWidth > window.innerWidth - padding) {
        left = window.innerWidth - menu.offsetWidth - padding;
    }

    // Vertikal tekshiruv
    if (top < padding) top = padding;
    if (top + menu.offsetHeight > window.innerHeight - padding) {
        top = window.innerHeight - menu.offsetHeight - padding;
    }

    menu.style.top = `${top}px`;
    menu.style.left = `${left}px`;

    // 5. MA'LUMOTLARNI SAQLASH
    selectedMsgId = id;
    selectedMsgText = content;
    
    // Fonni xiralashtirish (Telegram effektini beradi)
    const msgBox = document.getElementById('msgBox');
    msgBox.style.filter = "blur(2px)";
    msgBox.style.transition = "filter 0.2s";

    // Menyu ochilganda xabarni ajratib ko'rsatish (ixtiyoriy)
    msgElement.style.zIndex = "10001";
    msgElement.style.position = "relative";

    // Bir marta bosilganda menyuni yopish
    const autoClose = () => {
        closeMenu();
        document.removeEventListener('click', autoClose);
    };
    
// showMenu funksiyasi oxirida mana buni ishlating:
setTimeout(() => {
    // click hodisasi faqat bir marta ishlashi uchun {once: true} foydali
    document.addEventListener('click', closeMenu, { once: true });
}, 50);
}

// closeMenu funksiyasini ham moslashtiramiz
function closeMenu() {
    const menu = document.getElementById('msgContextMenu');
    const msgBox = document.getElementById('msgBox');
    
    // 1. Menyuni yashirish
    menu.style.display = 'none';
    menu.classList.add('hidden');
    
    msgBox.style.filter = "none"; 
    msgBox.classList.remove('blur-sm'); 
    
    document.removeEventListener('click', closeMenu);
}

function closeMenu() {
    const menu = document.getElementById('msgContextMenu');
    menu.style.display = 'none';
    document.getElementById('msgBox').classList.remove('blur-sm');
    document.removeEventListener('click', closeMenu);
}

// 3. Swipe to Reply (Surish orqali javob berish)
function initSwipe(element, msgId, text, sender) {
    let startX = 0;
    let currentX = 0;
    let isSwiping = false;

    element.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        element.style.transition = "none"; 
    }, {passive: true});

    element.addEventListener('touchmove', e => {
        currentX = e.touches[0].clientX;
        let diff = currentX - startX; // ENDI: O'ngga surish uchun (current - start)

        if (diff > 0 && diff < 80) { // Faqat o'ngga 80px gacha surish
            isSwiping = true;
            element.style.transform = `translateX(${diff}px)`; // Musbat qiymat o'ngga suradi
            
            // Ixtiyoriy: Surish paytida reply belgisi (icon) ko'rinishi uchun
            // element.querySelector('.swipe-indicator').style.opacity = diff / 80;
        }
    }, {passive: true});

    element.addEventListener('touchend', () => {
        element.style.transition = "transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)"; 
        element.style.transform = `translateX(0)`; // Joyiga qaytarish

        // Agar 50px dan ko'proq o'ngga surilgan bo'lsa - Reply!
        if (isSwiping && (currentX - startX > 50)) {
            setupReply(msgId, text, sender);
        }
        isSwiping = false;
    });
}



// 1. Replyni o'rnatish
function setupReply(id, text, sender) {
    replyToId = id;
    replyToText = text;
    replyToSender = sender;

    const preview = document.getElementById('replyPreview');
    preview.innerHTML = `
        <div class="flex items-center p-2 gap-3">
            <div class="flex-1 min-w-0">
                <p class="text-[11px] font-bold text-blue-600">${sender}</p>
                <p class="text-xs text-gray-600 truncate opacity-80">${text}</p>
            </div>
            <i onclick="cancelReply()" class="fa-solid fa-xmark text-gray-400 p-2 cursor-pointer"></i>
        </div>
    `;
    preview.classList.remove('hidden');
    document.getElementById('msgInp').focus();
}

function cancelReply() {
    replyToId = null;
    document.getElementById('replyPreview').classList.add('hidden');
}

// 2. Selection (Tanlash) rejimi
function toggleSelectMode() {
    isSelectionMode = true;
    selectedMessages.clear();
    document.getElementById('msgBox').classList.add('selection-active');
    closeMenu();
}

function toggleMsgSelection(id) {
    if (!isSelectionMode) return;
    
    const container = document.getElementById(`container-${id}`);
    if (selectedMessages.has(id)) {
        selectedMessages.delete(id);
        container.classList.remove('selected-msg');
    } else {
        selectedMessages.add(id);
        container.classList.add('selected-msg');
    }

    // Panelni ko'rsatish yoki yashirish
    const bar = document.getElementById('selectionBar');
    if (selectedMessages.size > 0) {
        bar.classList.remove('hidden');
        bar.style.display = 'flex';
    } else {
        bar.classList.add('hidden');
        bar.style.display = 'none';
    }
}

function cancelSelection() {
    isSelectionMode = false;
    selectedMessages.clear();
    document.querySelectorAll('.msg-container').forEach(el => el.classList.remove('selected-msg'));
    document.getElementById('selectionBar').classList.add('hidden');
    document.getElementById('msgBox').classList.remove('selection-active');
}
function cancelReply() {
    replyToId = null;
    replyToText = "";
    replyToSender = "";
    document.getElementById('replyPreview').classList.add('hidden');
}
// 5. Forward (Boshqaga yuborish)
function handleForward() {
    const forwardText = selectedMsgText;
    const targetUser = prompt("Kimga yubormoqchisiz? (Username)");
    if(targetUser) {
    // To'g'ri misol:
        socket.emit('send_message', {
            sender: currentUser,
            receiver: activeChat,
            content: messageText,
            type: 'text'
        });
        alert("Yuborildi!");
    }
    closeMenu();
}
function bindContextEvents(element, data) {
    let pressTimer;
    const isMe = data.sender === currentUser;

    // --- DESKTOP: O'NG TUGMA ---
    element.oncontextmenu = function(e) {
        e.preventDefault();
        e.stopPropagation();
        showMenu(e, data.id, data.content, isMe);
        return false;
    };

    // 1. Qurilmani aniqlash
function updateDeviceInfo() {
    const ua = navigator.userAgent;
    let device = "Personal Computer";

    if (/Android/i.test(ua)) device = "Android Smartphone";
    if (/iPhone/i.test(ua)) device = "Apple iPhone";
    if (/iPad/i.test(ua)) device = "Apple iPad";
    if (/Windows/i.test(ua)) device = "Windows Kompyuter";
    if (/Macintosh/i.test(ua)) device = "MacOS Kompyuter";

    document.getElementById("currentDevice").innerText = device;

    // Saqlab qo'yish (ixtiyoriy)
    localStorage.setItem("device", device);
}

// 2. Dark Mode
function toggleDarkMode(checkbox) {
    if (checkbox.checked) {
        document.body.classList.add('dark-mode');
        // Maxsus ranglar o'zgarishi
        document.querySelectorAll('.bg-white').forEach(el => el.style.backgroundColor = '#2c2c2e');
        document.querySelectorAll('.text-gray-900').forEach(el => el.style.color = '#ffffff');
        document.querySelectorAll('.text-gray-800').forEach(el => el.style.color = '#f2f2f7');
    } else {
        document.body.classList.remove('dark-mode');
        document.querySelectorAll('.bg-white').forEach(el => el.style.backgroundColor = '#ffffff');
        document.querySelectorAll('.text-gray-900').forEach(el => el.style.color = '#111827');
        document.querySelectorAll('.text-gray-800').forEach(el => el.style.color = '#1f2937');
    }
}

// 1. Profil ma'lumotlarini yuklash
function updateProfileUI() {
    const user = localStorage.getItem('username') || 'Mehmon';
    const phone = localStorage.getItem('user_phone') || '+998 00 000 00 00';
    
    document.getElementById('profileNameDisplay').innerText = user;
    document.getElementById('displayUsername').innerText = '@' + user;
    document.getElementById('profilePhoneDisplay').innerText = phone;
    
    // Avatar rasm yuklash (UI uchun)
    const avatarUrl = `https://ui-avatars.com/api/?name=${user}&background=007aff&color=fff&size=128`;
    document.getElementById('profileDisplayPic').src = avatarUrl;
    document.getElementById('userAvatar').src = avatarUrl;
}

// 2. Tab almashtirishda Profilni yangilash
const originalSwitchTab = switchTab; // Agar switchTab avval e'lon qilingan bo'lsa
switchTab = function(tabName) {
    // Eski switchTab funksiyasini chaqirish
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(tabName + 'Tab').classList.remove('hidden');
    
    // Profil yoki Sozlamalar ochilganda UI ni yangilash
    if(tabName === 'profile' || tabName === 'settings') {
        updateProfileUI();
        checkAdminAccess(); // Admin tugmasini tekshirish
    }
    
    // Navigatsiyani yangilash (Oldingi kodingizga moslash)
    updateNavUI(tabName); 
}

// 3. Admin Panelni ochish (Haqiqiy interfeys)
function showAdminPanel() {
    const panel = document.createElement('div');
    panel.id = "adminOverlay";
    panel.className = "fixed inset-0 bg-black z-[100] p-6 font-mono text-green-500 overflow-y-auto";
    panel.innerHTML = `
        <div class="flex justify-between items-center border-b border-green-900 pb-4 mb-6">
            <h2 class="text-xl font-bold tracking-tighter">SAFECHAT_CORE_ROOT</h2>
            <button onclick="document.getElementById('adminOverlay').remove()" class="bg-red-600 text-white px-3 py-1 rounded text-xs">EXIT</button>
        </div>
        <div class="space-y-4">
            <div class="bg-green-950/30 p-4 rounded border border-green-900">
                <p class="text-xs opacity-50 mb-2">SYSTEM_STATUS:</p>
                <div class="flex justify-between text-sm">
                    <span>Server: <b class="text-green-400">ONLINE</b></span>
                    <span>Users: <b class="text-green-400">1,240</b></span>
                </div>
            </div>
            <table class="w-full text-[10px] text-left">
                <thead class="bg-green-900 text-black">
                    <tr><th class="p-2">User</th><th class="p-2">IP</th><th class="p-2">Status</th></tr>
                </thead>
                <tbody id="adminUsersList">
                    <tr class="border-b border-green-900/30"><td class="p-2">@admin</td><td class="p-2">127.0.0.1</td><td class="p-2">Root</td></tr>
                    <tr class="border-b border-green-900/30"><td class="p-2">@jasur_dev</td><td class="p-2">94.158.1.1</td><td class="p-2 text-yellow-500">Active</td></tr>
                </tbody>
            </table>
        </div>
    `;
    document.body.appendChild(panel);
}

function loadTheme() {
    const savedTheme = localStorage.getItem("theme");

    if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
    }
}
loadTheme(); // birinchi chaqirilishi


// 3. Ma'lumotlarni o'zgartirish (Prompt orqali)
async function editValue(type) {
    let newVal = prompt(`Yangi ${type}ni kiriting:`);

    if (!newVal || newVal.trim() === "") {
        alert("Qiymat bo'sh boâ€˜la olmaydi!");
        return;
    }

    // Username boâ€˜lsa, domain qoâ€˜shamiz
    if (type === "username") {
        if (!newVal.includes(".connect.uz")) {
            newVal = newVal + ".connect.uz";
        }
    }

    // API endpoint
    const endpoint =
        type === "password"
            ? "/api/update_password"
            : "/api/update_user";

    // Yuboriladigan ma'lumot
    const body = {
        user: currentUser,
        field: type,
        value: newVal
    };

    try {
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert("Ma'lumotlar muvaffaqiyatli yangilandi!");

            // Username yangilanganda localStorage yangilaymiz
            if (type === "username") {
                localStorage.setItem("user", newVal);
            }

            // Logout qilish
            alert("Iltimos, tizimga qaytadan kiring.");
            logout();
        } else {
            alert("Xatolik yuz berdi, yana urinib koâ€˜ring.");
        }
    } catch (err) {
        console.error("Xato:", err);
        alert("Server bilan ulanishda muammo!");
    }
}

async function loadAdminStats() {
    const res = await fetch('/api/admin/stats');
    const data = await res.json();
    // Admin paneldagi HTML elementlarga qiymatlarni yozish
    document.getElementById('stat_total').innerText = data.total;
    document.getElementById('stat_online').innerText = data.online;
}

function submitApplication() {
    const data = {
        name: document.getElementById('app_name').value,
        phone: document.getElementById('app_phone').value,
        reason: document.getElementById('app_reason').value
    };
    fetch('/api/apply', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    }).then(() => {
        alert("Ariza yuborildi!");
        closeSheet('applySheet');
    });
}

// 4. Admin tugmasini tekshirish (Faqat sizning raqam uchun)
function checkAdminAccess() {
    const phone = localStorage.getItem('user_phone');
    if(phone === '958883851' || phone === '+998958883851') {
        document.getElementById('adminAccessBtn').classList.remove('hidden');
    }
}

// Sahifa yuklanganda barchasini ishga tushirish
window.addEventListener('load', () => {
    updateDeviceInfo();
    checkAdminAccess();
});
    // --- MOBILE: UZOQ BOSIB TURISH ---
    element.addEventListener('touchstart', function(e) {
        // Agar tanlash (select) rejimida bo'lsak, menyu chiqmasin
        if (isSelectionMode) return;

        pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50); // Vibratsiya
            
            // Sensor nuqtasini olish
            const touch = e.touches[0];
            showMenu(touch, data.id, data.content, isMe);
        }, 600); // 600ms - uzoq bosish vaqti
    }, { passive: true });

    element.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });

    element.addEventListener('touchmove', function() {
        clearTimeout(pressTimer); // Skrol qilinganda menyuni chiqarmaslik
    });
}
function updateAllUI() {
    const user = {
        name: localStorage.getItem('username') || 'Mehmon',
        phone: localStorage.getItem('user_phone') || 'Raqam kiritilmagan',
        bio: localStorage.getItem('user_bio') || 'Bio ma\'lumotlar yo\'q'
    };

    // Profil va Sozlamalardagi barcha matnlarni yangilash
    const elements = {
        'profileNameDisplay': user.name,
        'profilePhoneDisplay': user.phone,
        'displayUsername': '@' + user.name.toLowerCase().replace(/\s/g, ''),
        'displayBio': user.bio,
        'editNameInp': user.name, // Agar input qo'shsangiz
        'editBioInp': user.bio     // Agar input qo'shsangiz
    };

    for (let id in elements) {
        let el = document.getElementById(id);
        if (el) {
            if (el.tagName === 'INPUT') el.value = elements[id];
            else el.innerText = elements[id];
        }
    }

    // Rasmlarni yangilash
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=007aff&color=fff`;
    if(document.getElementById('profileDisplayPic')) document.getElementById('profileDisplayPic').src = avatarUrl;
    if(document.getElementById('userAvatar')) document.getElementById('userAvatar').src = avatarUrl;
}

// Agar ilova allaqachon o'rnatilgan bo'lsa, bannerni ko'rsatmaslik
window.addEventListener('appinstalled', () => {
    installBanner.style.display = 'none';
    deferredPrompt = null;
});

         </script>
</body>
</html>